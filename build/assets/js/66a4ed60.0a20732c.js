"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6722],{3905:(e,t,n)=>{n.d(t,{Zo:()=>o,kt:()=>f});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),i=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):u(u({},t),e)),n},o=function(e){var t=i(e.components);return a.createElement(s.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,o=c(e,["components","mdxType","originalType","parentName"]),p=i(n),h=r,f=p["".concat(s,".").concat(h)]||p[h]||d[h]||l;return n?a.createElement(f,u(u({ref:t},o),{},{components:n})):a.createElement(f,u({ref:t},o))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,u=new Array(l);u[0]=h;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c[p]="string"==typeof e?e:r,u[1]=c;for(var i=2;i<l;i++)u[i]=n[i];return a.createElement.apply(null,u)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},8121:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>u,default:()=>d,frontMatter:()=>l,metadata:()=>c,toc:()=>i});var a=n(7462),r=(n(7294),n(3905));const l={},u="\u6d3e\u53d1\u66f4\u65b0",c={unversionedId:"frameworks/vue2/reactivity/dispatch-update",id:"frameworks/vue2/reactivity/dispatch-update",title:"\u6d3e\u53d1\u66f4\u65b0",description:"\u5927\u767d\u8bdd\u8bf4\uff0c\u5c31\u662f\u5728\u6570\u636e\u6539\u53d8\u4e86\u7684\u65f6\u5019\uff0c\u901a\u77e5\u6570\u636e\u7684\u4f7f\u7528\u65b9\u3002",source:"@site/docs/05-frameworks/02-vue2/04-reactivity/04-dispatch-update.md",sourceDirName:"05-frameworks/02-vue2/04-reactivity",slug:"/frameworks/vue2/reactivity/dispatch-update",permalink:"/docs/frameworks/vue2/reactivity/dispatch-update",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/05-frameworks/02-vue2/04-reactivity/04-dispatch-update.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{},sidebar:"vue2",previous:{title:"\u4f9d\u8d56\u6536\u96c6",permalink:"/docs/frameworks/vue2/reactivity/collect-deps"},next:{title:"\u89c6\u56fe\u66f4\u65b0",permalink:"/docs/frameworks/vue2/reactivity/view-update"}},s={},i=[{value:"\u8ba2\u9605\u8005\u5206\u7c7b",id:"\u8ba2\u9605\u8005\u5206\u7c7b",level:2},{value:"\u524d\u7f6e\u5185\u5bb9",id:"\u524d\u7f6e\u5185\u5bb9",level:2},{value:"setter",id:"setter",level:2},{value:"notify",id:"notify",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}],o={toc:i},p="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(p,(0,a.Z)({},o,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u6d3e\u53d1\u66f4\u65b0"},"\u6d3e\u53d1\u66f4\u65b0"),(0,r.kt)("p",null,"\u5927\u767d\u8bdd\u8bf4\uff0c\u5c31\u662f\u5728\u6570\u636e\u6539\u53d8\u4e86\u7684\u65f6\u5019\uff0c\u901a\u77e5\u6570\u636e\u7684\u4f7f\u7528\u65b9\u3002"),(0,r.kt)("p",null,"\u6d3e\u53d1\u66f4\u65b0/\u53d1\u5e03\u66f4\u65b0\uff0c\u662f\u5411\u8c01\u6d3e\u53d1/\u53d1\u5e03\uff1f\u662f\u5411\u8ba2\u9605\u8005\u6d3e\u53d1\uff0c\u800c\u8c01\u662f\u8ba2\u9605\u8005\uff0c\u5728 Vue \u4e2d\u5c31\u662f Watcher \u5b9e\u4f8b\u3002\u6570\u636e\u66f4\u65b0\u7684\u8ba2\u9605\u8005\uff0c\u5177\u4f53\u6765\u8bf4\u662f Watcher\uff0c\u800c\u975e\u7ec4\u4ef6\uff0c\u7ec4\u4ef6\u7684 View \u66f4\u65b0\uff0c\u53ea\u662f\u5176\u4e2d\u4e00\u7c7b Watcher \u6536\u5230\u901a\u77e5\u540e\u7684\u5177\u4f53\u884c\u4e3a\u800c\u5df2\u3002"),(0,r.kt)("h2",{id:"\u8ba2\u9605\u8005\u5206\u7c7b"},"\u8ba2\u9605\u8005\u5206\u7c7b"),(0,r.kt)("p",null,"\u6b64\u5904\u6240\u8bf4\u7684\u8ba2\u9605\u8005\uff0c\u662f\u6570\u636e\u53d8\u5316\u7684\u8ba2\u9605\u8005\uff0c\u90a3\u4e48\u5728 Vue \u4e2d\uff0c\u8c01\u9700\u8981\u77e5\u9053\u6570\u636e\u53d8\u5316\u5462\uff1f\u662f\u4ee5\u4e0b\u4e09\u7c7b\u6570\u636e\u4f7f\u7528\u65b9\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u89c6\u56fe\uff1a\u6bd4\u5982 SFC \u4e2d HTML \u90e8\u5206\u7ed1\u5b9a\u4e86\u67d0\u4e2a\u5c5e\u6027\uff0c\u5219\u6570\u636e\u53d8\u5316\u65f6\u9700\u8981\u66f4\u65b0\u89c6\u56fe"),(0,r.kt)("li",{parentName:"ul"},"computed\uff1a\u4f9d\u8d56\u5c5e\u6027\u53d8\u5316\u540e\u9700\u8981\u91cd\u65b0\u8ba1\u7b97"),(0,r.kt)("li",{parentName:"ul"},"watch\uff1a\u4f9d\u8d56\u5c5e\u6027\u53d8\u5316\u540e\uff0c\u9700\u8981\u6267\u884c")),(0,r.kt)("p",null,"\u5728 vm \u4e2d\uff0c\u4e0e watcher \u76f8\u5173\u7684\u5c5e\u6027\u6709 vm.","_","watcher \u548c vm.","_","watchers"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"vm.","_","watcher\uff1a\u5355\u4e2a Watcher \u5b9e\u4f8b\uff0c\u8fd9\u4e2a\u662f\u6240\u8c13\u7684 render watcher\uff0c\u5bf9\u5e94\u89c6\u56fe"),(0,r.kt)("li",{parentName:"ul"},"vm.","_","watchers\uff1acomputed \u548c watch \u5bf9\u5e94\u7684 watcher \u90fd\u4fdd\u5b58\u5728\u6b64\u5904\u3002\u8fd9\u7c7b watcher \u4e5f\u88ab\u79f0\u4f5c user watcher\uff0c\u6211\u5206\u522b\u79f0\u4e3a computed watcher \u548c watch watcher")),(0,r.kt)("h2",{id:"\u524d\u7f6e\u5185\u5bb9"},"\u524d\u7f6e\u5185\u5bb9"),(0,r.kt)("p",null,"\u5728 data \u521d\u59cb\u5316\u65f6\uff0c\u5bf9\u4e8e Object \u7c7b\u578b\u7684\u5c5e\u6027\uff0c\u4f1a\u8c03\u7528 defineReactive \u5bf9\u6bcf\u4e2a\u5c5e\u6027\u5b9a\u4e49 getter/setter\uff0c\u4ee5\u8fdb\u884c\u4f9d\u8d56\u6536\u96c6\u548c\u66f4\u65b0\u6d3e\u53d1\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"walk (obj: Object) {\n  const keys = Object.keys(obj)\n  for (let i = 0; i < keys.length; i++) {\n    defineReactive(obj, keys[i])\n  }\n}\n\nexport function defineReactive (\n  obj: Object,\n  key: string,\n  val: any,\n  customSetter?: ?Function,\n  shallow?: boolean\n) {\n  const dep = new Dep()\n\n  const property = Object.getOwnPropertyDescriptor(obj, key)\n  if (property && property.configurable === false) {\n    return\n  }\n\n  // cater for pre-defined getter/setters\n  const getter = property && property.get\n  const setter = property && property.set\n  if ((!getter || setter) && arguments.length === 2) {\n    val = obj[key]\n  }\n\n  let childOb = !shallow && observe(val)\n  Object.defineProperty(obj, key, {\n    enumerable: true,\n    configurable: true,\n    get: function reactiveGetter () {\n      // ...\n    },\n    set: function reactiveSetter (newVal) {\n      const value = getter ? getter.call(obj) : val\n      /* eslint-disable no-self-compare */\n      if (newVal === value || (newVal !== newVal && value !== value)) {\n        return\n      }\n      /* eslint-enable no-self-compare */\n      if (process.env.NODE_ENV !== 'production' && customSetter) {\n        customSetter()\n      }\n      // #7981: for accessor properties without setter\n      if (getter && !setter) return\n      if (setter) {\n        setter.call(obj, newVal)\n      } else {\n        val = newVal\n      }\n      childOb = !shallow && observe(newVal)\n      dep.notify()\n    }\n  })\n}\n")),(0,r.kt)("p",null,"setter \u5c31\u662f\u6709\u6548\u4fee\u6539\u6570\u636e\u65f6\u5fc5\u8981\u7ecf\u8fc7\u7684\u5730\u65b9\uff0c\u662f\u5bf9\u66f4\u65b0\u8fdb\u884c\u6d3e\u53d1\u7684\u5f00\u59cb\uff0c\u662f\u672c\u6587\u7814\u7a76\u7684\u5185\u5bb9\u3002"),(0,r.kt)("h2",{id:"setter"},"setter"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"set: function reactiveSetter (newVal) {\n  const value = getter ? getter.call(obj) : val\n  /* eslint-disable no-self-compare */\n  if (newVal === value || (newVal !== newVal && value !== value)) {\n    return\n  }\n  /* eslint-enable no-self-compare */\n  if (process.env.NODE_ENV !== 'production' && customSetter) {\n    customSetter()\n  }\n  // #7981: for accessor properties without setter\n  if (getter && !setter) return\n  if (setter) {\n    setter.call(obj, newVal)\n  } else {\n    val = newVal\n  }\n  childOb = !shallow && observe(newVal)\n  dep.notify()\n}\n")),(0,r.kt)("p",null,"\u5bf9 newVal \u548c value \u505a\u4e86\u4e00\u4e2a\u76f8\u7b49\u6027\u6bd4\u8f83\uff0c\u5982\u679c\u6ca1\u6709\u6539\u53d8\u5c31\u76f4\u63a5\u8fd4\u56de\uff0c\u7136\u540e\u5c31\u662f\u8c03\u7528\u81ea\u5b9a\u4e49 setter \u6216\u8005\u8bbe\u7f6e val \u7b49\u4e8e\u65b0\u7684\u503c\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"childOb = !shallow && observe(newVal);\n")),(0,r.kt)("p",null,"\u5c31\u662f\u5bf9\u65b0\u7684\u503c\u505a\u54cd\u5e94\u5f0f\u7684\u76d1\u542c\uff0c\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48",(0,r.kt)("strong",{parentName:"p"},"\u91cd\u65b0\u7ed9\u6574\u4e2a\u5bf9\u8c61\u8d4b\u503c\u53ef\u4ee5\u89e6\u53d1\u66f4\u65b0"),"\u3002"),(0,r.kt)("p",null,"dep.notify() \u5c31\u662f\u901a\u77e5\u6240\u6709\u8ba2\u9605\u8005 \u2014\u2014 \u6211\u5347\u7ea7\u4e86\uff01"),(0,r.kt)("h2",{id:"notify"},"notify"),(0,r.kt)("p",null,"\u7b80\u5355\u4ecb\u7ecd\u4e0b dep.notify"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export default class Dep {\n  // ...\n  notify() {\n    const subs = this.subs.slice();\n\n    for (let i = 0, l = subs.length; i < l; i++) {\n      subs[i].update();\n    }\n  }\n}\n")),(0,r.kt)("p",null,"\u5c31\u662f\u5bf9\u4e8e\u6bcf\u4e2a\u8ba2\u9605\u8005\u8c03\u7528\u5176 update \u65b9\u6cd5\uff0c\u8fd9\u91cc\u7684\u8ba2\u9605\u8005\u90fd\u662f Watcher \u5b9e\u4f8b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export default class Watcher {\n  // ...\n  update() {\n    /* istanbul ignore else */\n    if (this.lazy) {\n      this.dirty = true;\n    } else if (this.sync) {\n      this.run();\n    } else {\n      queueWatcher(this);\n    }\n  }\n  // ...\n}\n")),(0,r.kt)("p",null,"lazy \u662f\u7528\u4e8e computed \u7684\uff0c\u800c sync \u8868\u793a\u9700\u8981\u7acb\u5373\u6267\u884c watcher \u7684\u56de\u8c03\uff0c\u800c\u4e0d\u662f\u6309\u7167\u666e\u901a\u60c5\u51b5\u901a\u8fc7 nextTick \u6267\u884c\u3002\u73b0\u5728\u4e3b\u8981\u5173\u6ce8 queueWatcher\uff0c\u5b9a\u4e49\u5728 src/core/observer/scheduler.js\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'let has: { [key: number]: ?true } = {};\nlet circular: { [key: number]: number } = {};\nlet waiting = false;\nlet flushing = false;\n/**\n * Push a watcher into the watcher queue.\n * Jobs with duplicate IDs will be skipped unless it\'s\n * pushed when the queue is being flushed.\n */\nexport function queueWatcher(watcher: Watcher) {\n  const id = watcher.id;\n  if (has[id] == null) {\n    has[id] = true;\n    if (!flushing) {\n      queue.push(watcher);\n    } else {\n      // if already flushing, splice the watcher based on its id\n      // if already past its id, it will be run next immediately.\n      let i = queue.length - 1;\n      while (i > index && queue[i].id > watcher.id) {\n        i--;\n      }\n      queue.splice(i + 1, 0, watcher);\n    }\n    // queue the flush\n    if (!waiting) {\n      waiting = true;\n\n      if (process.env.NODE_ENV !== "production" && !config.async) {\n        flushSchedulerQueue();\n        return;\n      }\n      nextTick(flushSchedulerQueue);\n    }\n  }\n}\n')),(0,r.kt)("p",null,"\u903b\u8f91\u4e0a\u800c\u8a00\uff0c\u8c03\u7528 update \u5c31\u662f\u8981\u6267\u884c\u5bf9\u5e94\u7684\u66f4\u65b0\uff0c\u662f\u8c03\u7528\u6ce8\u518c\u5728 watcher \u4e0a\u7684\u56de\u8c03\uff0c\u4f46\u8fd9\u91cc\u5e76\u4e0d\u662f\u7acb\u5373\u8c03\u7528\uff0c\u800c\u662f\u5f15\u5165\u4e86 scheduler \u8c03\u5ea6\u5668\u5bf9\u8981\u66f4\u65b0\u7684 watcher \u8fdb\u884c\u7ba1\u7406\u8c03\u5ea6\u3002"),(0,r.kt)("p",null,"scheduler \u8d1f\u8d23\u4ece\u63a5\u6536\u66f4\u65b0\u6d88\u606f\u5230\u8c03\u7528 updated \u751f\u547d\u5468\u671f\u94a9\u5b50\uff0c\u5176\u4f5c\u7528\u5c31\u662f\u5bf9\u66f4\u65b0\u8fc7\u7a0b\u8fdb\u884c\u4f18\u5316\uff0c\u8fdb\u884c\u96c6\u4e2d\u66f4\u65b0\uff0c\u800c\u975e\u5b9e\u65f6\u66f4\u65b0\u3002"),(0,r.kt)("p",null,"\u8fd9\u91cc\u6d89\u53ca\u7684\u4e1c\u897f\u662f\u6bd4\u8f83\u591a\u7684\uff0c\u6211\u4eec\u4f7f\u7528\u4e00\u4e2a\u4f8b\u5b50\u8fdb\u884c\u8bb2\u89e3"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'new Vue({\n  data: {\n    name: "fengpeng",\n  },\n  template: `<div>\n    <div>name is: {{name}}</div>\n  </div>`,\n  mounted() {\n    setTimeout(() => {\n      this.name = "\u65b9\u5357\u541b";\n      this.name = "\u9a6c\u6708\u6708";\n    }, 3000);\n  },\n}).$mount("#app");\n')),(0,r.kt)("p",null,"\u66f4\u65b0 this.name \u65f6\uff0c\u4f1a\u7ecf\u8fc7\u524d\u9762\u6240\u63cf\u8ff0\u7684\u6d41\u7a0b\uff0c\u8fdb\u5165\u5230\u8fd9\u91cc\u7684 queueWatcher \u51fd\u6570\u3002\u9996\u5148\u901a\u8fc7 has","[id]","\u5224\u65ad watcher \u662f\u5426\u6dfb\u52a0\u5230\u4e86\u961f\u5217\u91cc\u9762\uff0c\u786e\u4fdd\u6bcf\u4e2a watcher \u53ea\u88ab\u52a0\u5165\u4e00\u6b21\uff0c\u50cf\u8fd9\u91cc\u8fde\u7eed\u4e24\u6b21\u7684\u8d4b\u503c\uff0c\u4f1a\u4e24\u6b21\u8fdb\u5165\u5230 queueWatcher\uff0c\u4f46\u7b2c\u4e8c\u6b21\u5c31\u4e0d\u4f1a\u8fdb\u5165\u5230 if \u5185\u90e8\u4e86\u3002"),(0,r.kt)("p",null,"\u7531\u4e8e\u8fd9\u91cc\u662f\u7b2c\u4e00\u6b21\u66f4\u65b0\uff0c!flushing \u548c!waiting \u6210\u7acb\uff0c\u4f1a\u5c06 watcher \u63a8\u5165\u5230\u961f\u5217\u91cc\u9762\uff0c\u7136\u540e\u6267\u884c\u4e86 nextTick(flushSchedulerQueue)\uff0cnextTick \u9700\u8981\u5355\u72ec\u8fdb\u884c\u8bb2\u89e3\uff0c\u5c31\u6309\u7167\u5b57\u9762\u610f\u4e49\uff0c\u7406\u89e3\u4e3a\u4e0b\u4e00\u4e2a\u7684\u4e8b\u4ef6\u5faa\u73af\u201ctick\u201d\u4e2d\u6267\u884c\u5373\u53ef\u3002"),(0,r.kt)("p",null,"\u6211\u4eec\u5148\u76f4\u63a5\u53d6\u770b flushSchedulerQueue \u7684\u5185\u5bb9"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'/**\n * Flush both queues and run the watchers.\n */\nfunction flushSchedulerQueue() {\n  currentFlushTimestamp = getNow();\n  flushing = true;\n  let watcher, id;\n\n  // Sort queue before flush.\n  // This ensures that:\n  // 1. Components are updated from parent to child. (because parent is always\n  //    created before the child)\n  // 2. A component\'s user watchers are run before its render watcher (because\n  //    user watchers are created before the render watcher)\n  // 3. If a component is destroyed during a parent component\'s watcher run,\n  //    its watchers can be skipped.\n  queue.sort((a, b) => a.id - b.id);\n\n  // do not cache length because more watchers might be pushed\n  // as we run existing watchers\n  for (index = 0; index < queue.length; index++) {\n    watcher = queue[index];\n    if (watcher.before) {\n      watcher.before();\n    }\n    id = watcher.id;\n    has[id] = null;\n    watcher.run();\n    // in dev build, check and stop circular updates.\n    if (process.env.NODE_ENV !== "production" && has[id] != null) {\n      circular[id] = (circular[id] || 0) + 1;\n      if (circular[id] > MAX_UPDATE_COUNT) {\n        warn(\n          "You may have an infinite update loop " +\n            (watcher.user\n              ? `in watcher with expression "${watcher.expression}"`\n              : `in a component render function.`),\n          watcher.vm\n        );\n        break;\n      }\n    }\n  }\n\n  // keep copies of post queues before resetting state\n  const activatedQueue = activatedChildren.slice();\n  const updatedQueue = queue.slice();\n\n  resetSchedulerState();\n\n  // call component updated and activated hooks\n  callActivatedHooks(activatedQueue);\n  callUpdatedHooks(updatedQueue);\n\n  // devtool hook\n  /* istanbul ignore if */\n  if (devtools && config.devtools) {\n    devtools.emit("flush");\n  }\n}\n')),(0,r.kt)("p",null,"\u9010\u6b65\u62c6\u89e3\u6765\u7406\u89e3"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"queue.sort((a, b) => a.id - b.id);\n")),(0,r.kt)("p",null,"\u8fd9\u4e00\u6b65\u662f\u6839\u636e id \u5bf9 watcher \u53bb\u505a\u6392\u5e8f\u3002\u5728\u7ec4\u4ef6\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u662f\u5148\u521b\u5efa\u7236\u7ec4\u4ef6\uff0c\u7136\u540e\u521b\u5efa\u5b50\u7ec4\u4ef6\uff0c\u800c\u4e14\u7ec4\u4ef6\u5185\u662f\u5148\u8bbe\u7f6e computed \u548c watch \u7b49\u5185\u5bb9\uff0c\u7136\u540e\u624d\u662f\u6e32\u67d3\uff0c\u56e0\u6b64\u8fd9\u4e2a\u6392\u5e8f\u53ef\u4ee5\u786e\u4fdd\u4ee5\u4e0b\u8fd9\u51e0\u4ef6\u5f88\u91cd\u8981\u7684\u4e8b\u60c5\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u786e\u4fdd\u5148\u7236\u540e\u5b50\u7684\u987a\u5e8f\uff1acreated \u59cb\u7ec8\u662f\u5148\u7236\u540e\u5b50\u7684\uff0c\u786e\u4fdd\u8fd9\u4e2a\u4e4b\u540e\uff0cprops \u548c injected \u7b49\u5c31\u53ef\u4ee5\u5728\u5b50\u7ec4\u4ef6\u83b7\u53d6\u5230\u66f4\u65b0\u540e\u7684\u503c\u3002"),(0,r.kt)("li",{parentName:"ul"},"\u786e\u4fdd\u5148 user watchers\uff0c\u518d render watcher\uff1a\u6240\u8c13\u7684 user watchers \u5c31\u662f computed \u548c watch \u5bf9\u5e94\u7684 watcher\uff0c\u800c render watcher \u662f\u7ec4\u4ef6\u89c6\u56fe\u6240\u7528\u7684 watcher\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u4ee3\u8868\u7740 html template \u90e8\u5206\u3002\u4e5f\u5c31\u662f\u5728\u6e32\u67d3\u66f4\u65b0\u4e4b\u524d\uff0c\u8981\u5148\u8ba1\u7b97 computed\uff0c\u8981\u5148\u6267\u884c watch\u3002"),(0,r.kt)("li",{parentName:"ul"},"\u5982\u679c\u7236\u7ec4\u4ef6\u7684 watcher \u6267\u884c\u671f\u95f4\uff0c\u5b50\u7ec4\u4ef6\u88ab\u9500\u6bc1\uff0c\u90a3\u4e48\u5b50\u7ec4\u4ef6\u7684 watcher \u5c31\u53ef\u4ee5\u8df3\u8fc7\u4e86\u3002")),(0,r.kt)("p",null,"\u63a5\u4e0b\u6765\u662f\u904d\u5386\u961f\u5217\u6267\u884c watcher"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// do not cache length because more watchers might be pushed\n// as we run existing watchers\nfor (index = 0; index < queue.length; index++) {\n  watcher = queue[index];\n  if (watcher.before) {\n    watcher.before();\n  }\n  id = watcher.id;\n  has[id] = null;\n  watcher.run();\n}\n")),(0,r.kt)("p",null,"\u8fd9\u91cc\u6ce8\u91ca\u8bf4\uff0c\u4e0d\u8981\u7f13\u5b58 length \u5c5e\u6027\uff0c\u56e0\u4e3a\u5728 watcher.run \u4e2d\u53ef\u80fd\u8fd8\u4f1a\u589e\u52a0\u65b0\u7684 watcher\uff0c\u5728\u8fd9\u6267\u884c\u4e86 watcher.run \u51fd\u6570"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'/**\n * Scheduler job interface.\n * Will be called by the scheduler.\n */\nrun () {\n  if (this.active) {\n    const value = this.get()\n    if (\n      value !== this.value ||\n      // Deep watchers and watchers on Object/Arrays should fire even\n      // when the value is the same, because the value may\n      // have mutated.\n      isObject(value) ||\n      this.deep\n    ) {\n      // set new value\n      const oldValue = this.value\n      this.value = value\n      if (this.user) {\n        try {\n          this.cb.call(this.vm, value, oldValue)\n        } catch (e) {\n          handleError(e, this.vm, `callback for watcher "${this.expression}"`)\n        }\n      } else {\n        this.cb.call(this.vm, value, oldValue)\n      }\n    }\n  }\n}\n')),(0,r.kt)("p",null,"watcher.run \u5c31\u662f\u6267\u884c\u4e86 watcher.get \u51fd\u6570\uff0c\u6839\u636e\u524d\u9762\u5728 ",(0,r.kt)("a",{parentName:"p",href:"/docs/frameworks/vue2/render/watcher"},"Watcher")," \u4e2d\u7684\u8bf4\u660e\uff0c\u5bf9\u4e8e render watcher\uff0c\u8fd9\u4e2a\u5c31\u662f\u8fdb\u5165\u5230 updateComponent \u7684\u8fc7\u7a0b\uff0c\u5373\u66f4\u65b0\u7ec4\u4ef6\uff0c\u4e5f\u5c31\u662f\u8bf4 DOM \u7684\u66f4\u65b0\u662f\u5728\u8fd9\u91cc\u5b9e\u73b0\u7684\u3002"),(0,r.kt)("p",null,"\u518d\u5f80\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// keep copies of post queues before resetting state\nconst activatedQueue = activatedChildren.slice();\nconst updatedQueue = queue.slice();\n")),(0,r.kt)("p",null,"activatedQueue \u662f\u548c keep-alive \u7ec4\u4ef6\u76f8\u5173\u7684\uff0ckeep-alive \u76f8\u5173\u7684\u5185\u5bb9\u540e\u7eed\u5728\u5176\u4ed6\u6587\u7ae0\u4e2d\u8be6\u7ec6\u8bb2\u89e3\u3002updatedQueue \u5c06 queue \u590d\u5236\u4e86\u4e00\u4efd\u3002"),(0,r.kt)("p",null,"\u7ee7\u7eed\u5f80\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"resetSchedulerState();\n")),(0,r.kt)("p",null,"\u5b9a\u4e49\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'/**\n * Reset the scheduler\'s state.\n */\nfunction resetSchedulerState() {\n  index = queue.length = activatedChildren.length = 0;\n  has = {};\n  if (process.env.NODE_ENV !== "production") {\n    circular = {};\n  }\n  waiting = flushing = false;\n}\n')),(0,r.kt)("p",null,"\u8fd9\u662f\u91cd\u7f6e\u8c03\u5ea6\u5668\u7684\u72b6\u6001\uff0c\u91cd\u7f6e\u4e86 waiting, flushing \u72b6\u6001\u4e3a\u521d\u59cb\u72b6\u6001\uff0c\u91cd\u7f6e has \u548c index \u8fd9\u4e9b\u904d\u5386\u76f8\u5173\u8fed\u4ee3\u5224\u65ad\u6570\u636e\u3002"),(0,r.kt)("p",null,"\u6700\u540e\u662f\u6267\u884c\u751f\u547d\u5468\u671f\u94a9\u5b50\u51fd\u6570"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// call component updated and activated hooks\ncallActivatedHooks(activatedQueue);\ncallUpdatedHooks(updatedQueue);\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'function callUpdatedHooks(queue) {\n  let i = queue.length;\n  while (i--) {\n    const watcher = queue[i];\n    const vm = watcher.vm;\n    if (vm._watcher === watcher && vm._isMounted && !vm._isDestroyed) {\n      callHook(vm, "updated");\n    }\n  }\n}\n')),(0,r.kt)("p",null,"\u8fd9\u91cc\u662f\u8c03\u7528 updated \u94a9\u5b50\u7684\u5730\u65b9\uff0c\u5b83\u7684\u5224\u65ad\u5176\u5b9e\u4f53\u73b0\u4e86\u5f88\u591a\u6709\u4ef7\u503c\u7684\u5185\u5bb9\u3002"),(0,r.kt)("p",null,"\u9996\u5148\u6bcf\u4e2a watcher \u90fd\u6709\u4e00\u4e2a watcher.vm \u6307\u5411\u6240\u5728\u7684\u7ec4\u4ef6\uff0c\u800c vm.","_","watcher \u662f render watcher\uff0c\u53ea\u6709\u662f vm.","_","watcher \u7684\u66f4\u65b0\u624d\u662f\u7ec4\u4ef6\u89c6\u56fe\u6e32\u67d3\u66f4\u65b0\uff0c\u9700\u8981\u6267\u884c\u76f8\u5e94\u7684\u7ec4\u4ef6\u94a9\u5b50\uff0c\u800c\u5176\u4ed6\u5982 computed \u6240\u5bf9\u5e94\u7684 user watcher\uff0c\u5c31\u4e0d\u9700\u8981\u3002"),(0,r.kt)("p",null,"\u6267\u884c\u5b8c updated \u4e4b\u540e\uff0c\u7ec4\u4ef6\u66f4\u65b0\u7684\u8fc7\u7a0b\u5c31\u5b8c\u6210\u4e86\u3002"),(0,r.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,r.kt)("p",null,"\u66f4\u65b0\u6570\u636e\u65f6\uff0c\u6267\u884c setter\uff0csetter \u8c03\u7528 dep.notify \u901a\u77e5\u6240\u6709\u7684\u8ba2\u9605\u8005\uff0c\u8fd9\u65f6\u5019\u5f15\u5165\u4e86\u66f4\u65b0\u7684\u4f18\u5316\u7b56\u7565\uff0c\u4f7f\u7528 scheduler \u6765\u8fdb\u884c\u66f4\u65b0\u7684\u8c03\u5ea6\uff0c\u5148\u5c06\u6240\u6709\u7684\u8ba2\u9605\u8005(watcher)\u6dfb\u52a0\u5230 queueWatcher \u961f\u5217\u91cc\u9762\uff0c\u7136\u540e\u8c03\u7528 nextTick \u6267\u884c\u66f4\u65b0\u3002"),(0,r.kt)("p",null,"\u5bf9\u4e8e\u7ec4\u4ef6\u66f4\u65b0\uff0c\u9700\u8981\u6709\u8fd9\u6837\u4e00\u4e2a\u8ba4\u8bc6 \u2014\u2014 \u7ec4\u4ef6\u66f4\u65b0\u5e76\u4e0d\u610f\u5473\u7740 updated \u751f\u547d\u5468\u671f\u94a9\u5b50\u7684\u6267\u884c\u3002 \u4ece\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u89d2\u5ea6\u770b\uff0c\u5728\u8c03\u7528 updated \u94a9\u5b50\u4e4b\u524d\u7684 computed \u7b49\u7684\u66f4\u65b0\u4e5f\u662f\u66f4\u65b0\uff0cupdated \u94a9\u5b50\u7684\u6267\u884c\uff0c\u662f\u4e00\u4e2a\u5f80\u5f80\u4f34\u968f\u7740\u89c6\u56fe\u5c42\u6539\u53d8\u7684\u66f4\u65b0\uff0c\u662f\u4e00\u4e2a\u6807\u5fd7\u6027\u7684\u72b6\u6001\uff0c\u4f46\u5728\u4e4b\u524d\uff0c\u6709\u5f88\u591a\u5185\u90e8\u7684\u66f4\u65b0\u3002"))}d.isMDXComponent=!0}}]);