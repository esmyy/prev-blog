"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5069],{3905:(e,n,t)=>{t.d(n,{Zo:()=>m,kt:()=>k});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var i=a.createContext({}),p=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},m=function(e){var n=p(e.components);return a.createElement(i.Provider,{value:n},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,i=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),c=p(t),d=r,k=c["".concat(i,".").concat(d)]||c[d]||u[d]||l;return t?a.createElement(k,s(s({ref:n},m),{},{components:t})):a.createElement(k,s({ref:n},m))}));function k(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,s=new Array(l);s[0]=d;var o={};for(var i in n)hasOwnProperty.call(n,i)&&(o[i]=n[i]);o.originalType=e,o[c]="string"==typeof e?e:r,s[1]=o;for(var p=2;p<l;p++)s[p]=t[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},377:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var a=t(7462),r=(t(7294),t(3905));const l={},s="parse",o={unversionedId:"frameworks/vue2/compiler/parse",id:"frameworks/vue2/compiler/parse",title:"parse",description:"\u7f16\u8bd1\u6838\u5fc3\u4e09\u6b65\u7684\u7b2c\u4e00\u6b65 \u2014\u2014 parse\uff0c\u8d1f\u8d23\u6a21\u677f\u7684\u89e3\u6790\u548c AST \u7684\u751f\u6210\u3002",source:"@site/docs/05-frameworks/02-vue2/02-compiler/03-parse.md",sourceDirName:"05-frameworks/02-vue2/02-compiler",slug:"/frameworks/vue2/compiler/parse",permalink:"/docs/frameworks/vue2/compiler/parse",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/05-frameworks/02-vue2/02-compiler/03-parse.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{},sidebar:"vue2",previous:{title:"AST",permalink:"/docs/frameworks/vue2/compiler/ast"},next:{title:"optimize",permalink:"/docs/frameworks/vue2/compiler/optimize"}},i={},p=[{value:"\u524d\u7f6e\u5185\u5bb9",id:"\u524d\u7f6e\u5185\u5bb9",level:2},{value:"parse",id:"parse-1",level:2},{value:"getOptionsProperties",id:"getoptionsproperties",level:2},{value:"defineLocalVariables",id:"definelocalvariables",level:2},{value:"defineCheckAndWarnFnsForDev",id:"definecheckandwarnfnsfordev",level:2},{value:"parseHTML",id:"parsehtml",level:2},{value:"\u6a21\u677f\u89e3\u6790",id:"\u6a21\u677f\u89e3\u6790",level:2},{value:"\u4f7f\u7528\u793a\u4f8b",id:"\u4f7f\u7528\u793a\u4f8b",level:3},{value:"comment",id:"comment",level:3},{value:"advance",id:"advance",level:2},{value:"doctype",id:"doctype",level:3},{value:"Start Tag",id:"start-tag",level:3},{value:"End Tag",id:"end-tag",level:3},{value:"Text",id:"text",level:3},{value:"\u751f\u6210 AST",id:"\u751f\u6210-ast",level:2},{value:"options.comment",id:"optionscomment",level:3},{value:"options.start",id:"optionsstart",level:3},{value:"\u521b\u5efa AST \u5143\u7d20",id:"\u521b\u5efa-ast-\u5143\u7d20",level:4},{value:"\u5904\u7406 AST \u5143\u7d20",id:"\u5904\u7406-ast-\u5143\u7d20",level:4},{value:"\u8bbe\u7f6e\u5143\u7d20\u5173\u7cfb",id:"\u8bbe\u7f6e\u5143\u7d20\u5173\u7cfb",level:4},{value:"end",id:"end",level:4},{value:"chars",id:"chars",level:4},{value:"closeElement",id:"closeelement",level:4},{value:"\u7279\u522b\u8bf4\u660e",id:"\u7279\u522b\u8bf4\u660e",level:2},{value:"ifConditions \u7684\u7279\u522b\u4e4b\u5904",id:"ifconditions-\u7684\u7279\u522b\u4e4b\u5904",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}],m={toc:p},c="wrapper";function u(e){let{components:n,...t}=e;return(0,r.kt)(c,(0,a.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"parse"},"parse"),(0,r.kt)("p",null,"\u7f16\u8bd1\u6838\u5fc3\u4e09\u6b65\u7684\u7b2c\u4e00\u6b65 \u2014\u2014 parse\uff0c\u8d1f\u8d23\u6a21\u677f\u7684\u89e3\u6790\u548c AST \u7684\u751f\u6210\u3002"),(0,r.kt)("p",null,"parse \u5403\u7684\u662f\u5b57\u7b26\u4e32\u7684 template \u6a21\u677f\uff0c\u5410\u7684\u662f\u4e00\u4e2a AST\uff0c\u662f\u4e00\u4e2a\u5bf9\u8c61\u3002"),(0,r.kt)("h2",{id:"\u524d\u7f6e\u5185\u5bb9"},"\u524d\u7f6e\u5185\u5bb9"),(0,r.kt)("p",null,"\u7f16\u8bd1\u7684\u4e3b\u8981\u6d41\u7a0b\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"src/compiler/index.js"),"\uff0c\u5185\u5bb9\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'import { parse } from "./parser/index";\nimport { optimize } from "./optimizer";\nimport { generate } from "./codegen/index";\nimport { createCompilerCreator } from "./create-compiler";\nexport const createCompiler = createCompilerCreator(function baseCompile(\n  template: string,\n  options: CompilerOptions\n): CompiledResult {\n  const ast = parse(template.trim(), options);\n  if (options.optimize !== false) {\n    optimize(ast, options);\n  }\n  isStatic;\n  const code = generate(ast, options);\n  return {\n    ast,\n    render: code.render,\n    staticRenderFns: code.staticRenderFns,\n  };\n});\n')),(0,r.kt)("p",null,"\u672c\u6587\u6211\u4eec\u7814\u7a76\u7684\u6a21\u677f\u7684\u89e3\u6790\u548c AST \u751f\u6210\u7684\u8fc7\u7a0b\uff0c\u5373 ",(0,r.kt)("inlineCode",{parentName:"p"},"parse")," \u51fd\u6570"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const ast = parse(template.trim(), options);\n")),(0,r.kt)("h2",{id:"parse-1"},"parse"),(0,r.kt)("p",null,"\u5b9a\u4e49\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"src/compiler/parser/index.js"),"\uff0c\u4f2a\u4ee3\u7801\u7684\u5c55\u793a\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export function parse (\n  template: string,\n  options: CompilerOptions\n): ASTElement | void {\n  getOptionsProperties(); // ...\n\n  defineLocalVariables(); // ...\n\n  defineCheckAndWarnFnsForDev(); // ...\n\n  parseHTML(template, {\n    ...partOfPropertiesOfoptions // ...\n\n    start (tag, attrs, unary, start, end) {\n      // ...\n    },\n\n    end (tag, start, end) {\n      // ...\n    },\n\n    chars (text: string, start: number, end: number) {\n      // ...\n    },\n\n    comment (text: string, start, end) {\n      // ...\n    }\n  })\n  return root\n}\n\n")),(0,r.kt)("p",null,"\u4e0b\u9762\u5c06\u4f1a\u4ece\u4e0a\u5f80\u4e0b\u89e3\u91ca\u5404\u90e8\u5206\uff0c\u5bf9\u4e8e parseHTML \u7684\u51e0\u4e2a\u51fd\u6570\u53c2\u6570\uff0c\u6682\u65f6\u4e0d\u7528\u53bb\u5173\u6ce8\uff0c\u540e\u9762\u8fdb\u884c\u5355\u72ec\u8bf4\u660e\u3002"),(0,r.kt)("h2",{id:"getoptionsproperties"},"getOptionsProperties"),(0,r.kt)("p",null,"\u8fd9\u662f\u83b7\u53d6\u4e00\u4e9b options \u91cc\u9762\u7684\u53d8\u91cf"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'warn = options.warn || baseWarn;\n\nplatformIsPreTag = options.isPreTag || no;\nplatformMustUseProp = options.mustUseProp || no;\nplatformGetTagNamespace = options.getTagNamespace || no;\nconst isReservedTag = options.isReservedTag || no;\nmaybeComponent = (el: ASTElement) => !!el.component || !isReservedTag(el.tag);\n\ntransforms = pluckModuleFunction(options.modules, "transformNode");\npreTransforms = pluckModuleFunction(options.modules, "preTransformNode");\npostTransforms = pluckModuleFunction(options.modules, "postTransformNode");\n\ndelimiters = options.delimiters;\n')),(0,r.kt)("p",null,"\u5176\u4e2d options \u5176\u5b9e\u662f\u6211\u4eec\u5728\u524d\u8bf4\u8fc7\u7684 baseOptions\uff0c\u5728 src/platforms/web/compiler/options.js \u4e2d\u5b9a\u4e49\uff0c\u5305\u542b\u4e00\u4e9b\u4e0e\u5e73\u53f0\u76f8\u5173\u7684\u7f16\u8bd1\u914d\u7f6e\uff0c\u5728\u5b66\u4e60 parse \u7684\u8fc7\u7a0b\u4e2d\u5176\u5b9e\u4e0d\u7528\u8fc7\u591a\u5173\u6ce8 options\u3002"),(0,r.kt)("h2",{id:"definelocalvariables"},"defineLocalVariables"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const stack = [];\nconst preserveWhitespace = options.preserveWhitespace !== false;\nconst whitespaceOption = options.whitespace;\nlet root;\nlet currentParent; // \u5f53\u524d\u67e5\u627e\u5230\u7684\u5143\u7d20\u7684\u7236\u5143\u7d20\nlet inVPre = false; // \u5728v-pre\u6807\u8bb0\u7684\u4e0d\u7528\u7f16\u8bd1\u7684\u7ec4\u4ef6\u4e2d\nlet inPre = false; // <pre></pre>\u6807\u7b7e\u4e2d\nlet warned = false;\n")),(0,r.kt)("p",null,"\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5728 parse \u5185\u90e8\u9700\u8981\u7684\u5c40\u90e8\u53d8\u91cf\uff0croot \u8868\u793a\u6839\u7ed3\u70b9\uff0cstack \u7528\u4f5c\u4e00\u4e2a\u6808\uff0c\u5728\u89e3\u6790\u8fc7\u7a0b\u4e2d\u4fdd\u5b58\u5df2\u89e3\u6790\u672a\u5339\u914d\u7684 AST \u5143\u7d20\u3002"),(0,r.kt)("h2",{id:"definecheckandwarnfnsfordev"},"defineCheckAndWarnFnsForDev"),(0,r.kt)("p",null,"\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5728\u5f00\u53d1\u73af\u5883\u4e0b\u62a5\u9519\u63d0\u793a\u7684\u68c0\u67e5\u65b9\u6cd5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'// \u6709\u591a\u79cd\u53ef\u80fd\u53d1\u751f\u5728\u4e00\u4e2a\u4f4d\u7f6e\u7684\u5f02\u5e38\u914d\u7f6e\u573a\u666f\uff0c\u53ea\u629b\u51fa\u6700\u5148\u9047\u5230\u7684\u60c5\u51b5\u5c31\u597d\u4e86\nlet warned = false;\nfunction warnOnce(msg, range) {\n  if (!warned) {\n    warned = true;\n    warn(msg, range);\n  }\n}\n\nfunction closeElement(element) {\n  // allow root elements with v-if, v-else-if and v-else\n}\n\nfunction trimEndingWhitespace(el) {\n  // remove trailing whitespace node\n}\n\nfunction checkRootConstraints(el) {\n  if (el.tag === "slot" || el.tag === "template") {\n    // \u63d0\u793a\u4e0d\u80fd\u7528slot\u6216template\u4f5c\u4e3a\u6839\u5143\u7d20\n  }\n  if (el.attrsMap.hasOwnProperty("v-for")) {\n    // \u63d0\u793a\u6839\u5143\u7d20\u4e0d\u80fd\u7528v-for\n  }\n}\n')),(0,r.kt)("p",null,"\u5728\u89e3\u6790\u7f16\u8bd1 template \u7684\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u80fd\u4f1a\u9047\u5230\u8fd9\u6837\u90a3\u6837\u7684\u4e0d\u7b26\u5408\u8981\u6c42\u7684\u914d\u7f6e\uff0c\u8fd9\u4e9b\u51fd\u6570\u4e3b\u8981\u5c31\u662f\u505a\u4e00\u4e9b\u68c0\u67e5\u548c\u63d0\u793a\u3002"),(0,r.kt)("h2",{id:"parsehtml"},"parseHTML"),(0,r.kt)("p",null,"parseHTML \u662f\u5c06 template \u8f6c\u6362\u4e3a AST \u7684\u5730\u65b9\uff0c\u5b9a\u4e49\u5728 src/compiler/parser/html-parser.js\uff0c\u4f2a\u4ee3\u7801\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'export function parseHTML(html, options) {\n  let last, lastTag;\n  while (html) {\n    last = html;\n    if (!lastTag || !isPlainTextElement(lastTag)) {\n      let textEnd = html.indexOf("<");\n      if (isComment) {\n        advance();\n        continue;\n      }\n\n      if (isDoctype) {\n        advance();\n        continue;\n      }\n\n      if (isEndTag) {\n        advance();\n        parseEndTag();\n        continue;\n      }\n\n      if (isStarTag) {\n        handleStartTag();\n        advance();\n        continue;\n      }\n\n      if (isText) {\n        advance();\n      }\n\n      if (options.chars && text) {\n        options.chars(text, index - text.length, index);\n      }\n    } else {\n      handlePlainTextElement();\n      parseEndTag();\n    }\n\n    if (html === last) {\n      break;\n    }\n  }\n\n  // Clean up any remaining tags\n  parseEndTag();\n\n  function advance(n) {\n    // ...\n  }\n\n  function parseStartTag() {\n    // ...\n  }\n\n  function handleStartTag(match) {\n    // ...\n  }\n\n  function parseEndTag(tagName, start, end) {\n    // ...\n  }\n}\n')),(0,r.kt)("p",null,"parseHTML \u5c31\u662f template \u5b57\u7b26\u4e32\u5339\u914d\u548c\u5904\u7406\u7684\u8fc7\u7a0b\uff0c\u6574\u4f53\u6765\u8bf4\u5c31\u662f\u4ece\u524d\u5411\u540e\u5339\u914d\uff0c\u6839\u636e\u4e0d\u540c\u7684\u5339\u914d\u60c5\u51b5\u505a\u4e0d\u540c\u7684\u5904\u7406\uff0c\u7136\u540e\u5bf9\u5269\u4e0b\u7684\u672a\u5339\u914d\u90e8\u5206\u7ee7\u7eed\u8fdb\u884c\u4e0b\u4e00\u8f6e\u7684\u5339\u914d\uff0c\u76f4\u5230\u6574\u4e2a\u5b57\u7b26\u4e32\u89e3\u6790\u5b8c\u6210\u3002"),(0,r.kt)("p",null,"\u5339\u914d\u7684\u5173\u952e\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"<")," \u8fd9\u4e2a\u5b57\u7b26\uff0c\u6bcf\u4e2a html tag \u4ee5\u8fd9\u4e2a\u5b57\u7b26\u4e3a\u8d77\u70b9\uff0c\u5411\u540e\u67e5\u627e\u5206\u6790\uff0c\u5224\u65ad\u540e\u9762\u8ddf\u7684\u5185\u5bb9\u662f\u4ec0\u4e48\u3002"),(0,r.kt)("h2",{id:"\u6a21\u677f\u89e3\u6790"},"\u6a21\u677f\u89e3\u6790"),(0,r.kt)("p",null,"\u89e3\u6790\u7684\u8fc7\u7a0b\u4e3b\u8981\u5c31\u662f\u5728\u627e\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"<")," \u4e4b\u540e\uff0c\u7528\u6b63\u5219\u5411\u540e\u5339\u914d\uff0c\u5339\u914d\u7528\u5230\u7684\u6b63\u5219\u5982\u4e0b:"),(0,r.kt)("p",null,"\u8fd9\u4e9b\u6b63\u5219\uff0c\u90fd\u662f\u7528\u6765\u505a\u6807\u7b7e\u6216\u8005\u5c5e\u6027\u5339\u914d\u7684\uff0c\u51e0\u4e2a\u6bd4\u8f83\u590d\u6742\u7684\u6b63\u5219\u53ef\u4ee5\u70b9\u51fb\u94fe\u63a5\u67e5\u770b\u76f4\u89c2\u7684\u56fe\u5f62\u5316\u8868\u793a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://regexper.com/#%2F%5E%3C%28%28%3F%3A%5Ba-zA-Z_%5D%5B%5C-%5C.0-9_a-zA-Za-zA-Z%5Cu00B7%5Cu00C0-%5Cu00D6%5Cu00D8-%5Cu00F6%5Cu00F8-%5Cu037D%5Cu037F-%5Cu1FFF%5Cu200C-%5Cu200D%5Cu203F-%5Cu2040%5Cu2070-%5Cu218F%5Cu2C00-%5Cu2FEF%5Cu3001-%5CuD7FF%5CuF900-%5CuFDCF%5CuFDF0-%5CuFFFD%5D*%5C%3A%29%3F%5Ba-zA-Z_%5D%5B%5C-%5C.0-9_a-zA-Za-zA-Z%5Cu00B7%5Cu00C0-%5Cu00D6%5Cu00D8-%5Cu00F6%5Cu00F8-%5Cu037D%5Cu037F-%5Cu1FFF%5Cu200C-%5Cu200D%5Cu203F-%5Cu2040%5Cu2070-%5Cu218F%5Cu2C00-%5Cu2FEF%5Cu3001-%5CuD7FF%5CuF900-%5CuFDCF%5CuFDF0-%5CuFFFD%5D*%29%2F%22"},"startTagOpen \u5339\u914d\u5f00\u59cb\u6807\u7b7e\u7684\u5f00\u59cb"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://regexper.com/#%2F%5E%5Cs*%28%5C%2F%3F%29%3E%2F%22"},"startTagClose \u5339\u914d\u5f00\u59cb\u6807\u7b7e\u7684\u7ed3\u675f"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://regexper.com/#%2F%5E%5Cs*%28%28%3F%3Av-%5B%5Cw-%5D%2B%3A%7C%40%7C%3A%7C%23%29%5C%5B%5B%5E%3D%5D%2B%5C%5D%5B%5E%5Cs%22'%3C%3E%5C%2F%3D%5D*%29%28%3F%3A%5Cs*%28%3D%29%5Cs*%28%3F%3A%22%28%5B%5E%22%5D*%29%22%2B%7C'%28%5B%5E'%5D*%29'%2B%7C%28%5B%5E%5Cs%22'%3D%3C%3E%60%5D%2B%29%29%29%3F%2F%22"},"dynamicArgAttribute \u5339\u914d\u52a8\u6001\u5c5e\u6027"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://regexper.com/#%2F%5E%5Cs*%28%5B%5E%5Cs%22%3E'%3C%3E%5C%2F%3D%5D%2B%29%28%3F%3A%5Cs*%28%3D%29%5Cs*%28%3F%3A%22%28%5B%5E%22%5D*%29%22%2B%7C'%28%5B%5E'%5D*%29'%2B%7C%28%5B%5E%5Cs%22'%3D%3C%3E%60%5D%2B%29%29%29%3F%2F%22"},"attribute \u5339\u914d\u666e\u901a\u5c5e"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://regexper.com/#%2F%5E%3C%5C%2F%28%28%3F%3A%5Ba-zA-Z_%5D%5B%5C-%5C.0-9_a-zA-Za-zA-Z%5Cu00B7%5Cu00C0-%5Cu00D6%5Cu00D8-%5Cu00F6%5Cu00F8-%5Cu037D%5Cu037F-%5Cu1FFF%5Cu200C-%5Cu200D%5Cu203F-%5Cu2040%5Cu2070-%5Cu218F%5Cu2C00-%5Cu2FEF%5Cu3001-%5CuD7FF%5CuF900-%5CuFDCF%5CuFDF0-%5CuFFFD%5D*%5C%3A%29%3F%5Ba-zA-Z_%5D%5B%5C-%5C.0-9_a-zA-Za-zA-Z%5Cu00B7%5Cu00C0-%5Cu00D6%5Cu00D8-%5Cu00F6%5Cu00F8-%5Cu037D%5Cu037F-%5Cu1FFF%5Cu200C-%5Cu200D%5Cu203F-%5Cu2040%5Cu2070-%5Cu218F%5Cu2C00-%5Cu2FEF%5Cu3001-%5CuD7FF%5CuF900-%5CuFDCF%5CuFDF0-%5CuFFFD%5D*%29%5B%5E%3E%5D*%3E%2F%22"},"endTag \u5339\u914d\u7ed3\u675f\u6807\u7b7e")))),(0,r.kt)("p",null,"\u5728\u8fdb\u884c\u6bcf\u4e2a\u7c7b\u522b\u7684\u5339\u914d\u8bf4\u660e\u4e4b\u524d\uff0c\u9996\u5148\u89e3\u91ca\u4e00\u4e0b\u904d\u5386\u5b57\u7b26\u4e32\u8fdb\u884c\u89e3\u6790\u7684\u5916\u5c42\u7ed3\u6784\uff0c\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'let index = 0; // \u6807\u8bb0\u5728\u539f\u59cb\u7684 template \u5b57\u7b26\u4e32\u4e2d\u7684\u4f4d\u7f6e\nlet last, lastTag;\nwhile (html) {\n  last = html;\n  if (!lastTag || !isPlainTextElement(lastTag)) {\n    let textEnd = html.indexOf("<"); // \u8868\u793a\u7684\u662f\u5728 rest(\u672a\u5339\u914d)\u5b57\u7b26\u4e32\u4e2d\u4e0b\u4e00\u4e2a<\u7684\u4f4d\u7f6e\n    // @block1\n  } else {\n    // @block2\n  }\n\n  if (html === last) {\n    // @block3\n  }\n}\n')),(0,r.kt)("p",null,"html \u662f",(0,r.kt)("strong",{parentName:"p"},"\u672a\u5339\u914d\u90e8\u5206"),"\uff0c\u8fd9\u610f\u5473\u7740\u5728 while \u5faa\u73af\u4e2d\uff0c\u53ea\u8981 template \u6a21\u677f\u5b57\u7b26\u4e32\u6ca1\u6709\u5339\u914d\u5230\u7ed3\u5c3e\u5c31\u4f1a\u7ee7\u7eed\u3002\u8fd9\u91cc\u6709\u4e09\u4e2a\u90e8\u5206"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"@block1\uff1a\u91cd\u70b9\u7814\u7a76\u7684\u90e8\u5206\uff0c\u8bf7\u8bb0\u4f4f textEnd \u8868\u793a\u7684\u662f\u5728 rest(\u672a\u5339\u914d)\u5b57\u7b26\u4e32\u4e2d\u4e0b\u4e00\u4e2a<\u7684\u4f4d\u7f6e\uff1b"),(0,r.kt)("li",{parentName:"ul"},"@block2\uff1a\u8fd9\u91cc\u662f\u5bf9\u4e8e textarea, script, style \u8fd9\u4e9b\u7684\u5904\u7406\uff0c\u8fd9\u4e00\u90e8\u5206\u662f\u6240\u8c13\u7684\u7eaf\u6587\u672c\uff0c\u5373\u4e2d\u95f4\u4e0d\u4f1a\u5d4c\u5957\u5176\u4ed6\u5b50\u5143\u7d20\uff0c\u8fd9\u90e8\u5206\u76f4\u63a5\u63d0\u53d6\uff0c\u7136\u540e\u7ee7\u7eed\u5411\u524d\u5373\u53ef"),(0,r.kt)("li",{parentName:"ul"},"@block3\uff1a\u5f02\u5e38\u60c5\u51b5\u4e0b\u65e0\u6cd5\u5b8c\u6210\u89e3\u6790\u65f6\u4e2d\u6b62\u7684\u9519\u8bef\u63d0\u793a\uff0c\u6bd4\u5982\u6a21\u677f\u6700\u540e\u6709\u4e00\u4e2a\u6807\u7b7e\u5f00\u59cb\u6807\u5fd7<")),(0,r.kt)("p",null,"\u6211\u4eec\u4e3b\u8981\u9488\u5bf9 @block1 \u91c7\u7528\u4ee5\u4e0b\u793a\u4f8b\u8fdb\u884c\u8bf4\u660e\u8fdb\u884c\u5b66\u4e60\uff0c\u5176\u4f59\u4e24\u4e2a\u4e0d\u518d\u505a\u8fc7\u591a\u89e3\u91ca"),(0,r.kt)("h3",{id:"\u4f7f\u7528\u793a\u4f8b"},"\u4f7f\u7528\u793a\u4f8b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const app = new Vue({\n  template: \'<div class="header">hello \x3c!-- this is a comment --\x3e</div>\',\n});\n\napp.$mount("#app");\n')),(0,r.kt)("h3",{id:"comment"},"comment"),(0,r.kt)("p",null,"\u6ce8\u91ca\u76f8\u5173\u7684\u89e3\u6790\u4ee3\u7801\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"if (textEnd === 0) {\n  if (comment.test(html)) {\n    const commentEnd = html.indexOf('--\x3e')\n\n    if (commentEnd >= 0) {\n      if (options.shouldKeepComment) {\n        options.comment(html.substring(4, commentEnd), index, index + commentEnd + 3)\n      }\n      advance(commentEnd + 3)\n      continue\n    }\n\n    // \u8fd9\u91cc\u7684\u6761\u4ef6\u6ce8\u91ca\u5c31\u7c7b\u4f3c\u4e8eIE\u7684\u90a3\u4e9b\u5224\u65ad\uff0c\u4e0d\u7ec6\u8bf4\u3002\n    if (conditionalComment.test(html)) {\n      const conditionalEnd = html.indexOf(']>')\n\n      if (conditionalEnd >= 0) {\n        advance(conditionalEnd + 2)\n        continue\n      }\n    }\n  }\n}\n")),(0,r.kt)("p",null,"\u6839\u636e\u6211\u4eec\u7684\u4f8b\u5b50\uff0c\u5f53 html \u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"\x3c!-- this is a comment --\x3e</div>"),"\u65f6\uff0c\u901a\u8fc7 comment.test(html) \u5224\u65ad\u51fa\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"\x3c!--")," \u5f00\u5934\u7684\u5339\u914d\uff0c\u8fd9\u4e2a\u65f6\u5019\u67e5\u627e ",(0,r.kt)("inlineCode",{parentName:"p"},"--\x3e")," \u8fd9\u4e2a\u6ce8\u91ca\u7ed3\u5c3e\uff0c\u627e\u5230\u4e4b\u540e\u5c06\u6ce8\u91ca\u901a\u8fc7 options.comment \u8fdb\u884c\u8bb0\u5f55\uff0c\u901a\u8fc7 ",(0,r.kt)("inlineCode",{parentName:"p"},"advance")," \u524d\u8fdb\u5230\u6b64\u5904\u5339\u914d\u7684\u6ce8\u91ca\u4e4b\u540e\uff0c\u8fdb\u884c\u4e0b\u4e00\u8f6e\u5339\u914d\u3002"),(0,r.kt)("h2",{id:"advance"},"advance"),(0,r.kt)("p",null,"advance \u63a7\u5236\u7684\u662f\u5339\u914d\u8fc7\u7a0b\u4e2d\u7684\u524d\u8fdb"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function advance(n) {\n  index += n;\n  html = html.substring(n);\n}\n")),(0,r.kt)("p",null,"\u529f\u80fd\u5c31\u662f\u622a\u6389 html \u7684\u524d ",(0,r.kt)("inlineCode",{parentName:"p"},"n")," \u4e2a\u5b57\u7b26\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u524d\u8fdb ",(0,r.kt)("inlineCode",{parentName:"p"},"n")," \u4e2a\u5b57\u7b26\u3002\u5728\u8fd9\u4e2a comment \u7684\u4f8b\u5b50\u4e2d\uff0cn \u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"commentEnd")," \u7684\u4f4d\u7f6e\uff0c\u4e5f\u5c31\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"--\x3e")," \u7684\u4f4d\u7f6e 23 \u52a0\u4e0a\u5176\u81ea\u8eab\u957f\u5ea6 3\uff0c\u5219 advance \u6267\u884c\u540e\uff0c\u4e0b\u4e00\u6b21\u5faa\u73af html \u4e3a\u53f3\u4fa7\u5269\u4e0b\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"</div>")),(0,r.kt)("admonition",{title:"\u8bf4\u660e",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"comment \u5339\u914d\u540e\u8fd8\u8c03\u7528\u4e86 options.comment\uff0c\u4f46\u662f\u6211\u4eec\u4e0d\u5728\u6b64\u5904\u6df1\u5165\u8fd9\u4e2a\u51fd\u6570\u3002\u5bf9\u4e8e options.xxx \u65b9\u6cd5\u7684\u8c03\u7528\uff0c\u6682\u65f6\u53ea\u9700\u8981\u77e5\u9053\u5728\u4f55\u5904\u8c03\u7528\u5373\u53ef\uff0c\u540e\u7eed\u5355\u72ec\u89e3\u91ca\u3002")),(0,r.kt)("h3",{id:"doctype"},"doctype"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const doctype = /^<!DOCTYPE [^>]+>/i\n\nconst doctypeMatch = html.match(doctype)\nif (doctypeMatch) {\n  advance(doctypeMatch[0].length)\n  continue\n}\n")),(0,r.kt)("p",null,"\u5bf9\u4e8e doctype \u58f0\u660e\uff0c\u5c31\u662f\u76f4\u63a5\u8df3\u8fc7\uff0cdoctype \u6ca1\u4ec0\u4e48\u9700\u8981\u89e3\u6790\u8f6c\u6362\u7684"),(0,r.kt)("h3",{id:"start-tag"},"Start Tag"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const isIgnoreNewlineTag = makeMap('pre,textarea', true)\nconst shouldIgnoreFirstNewline = (tag, html) => tag && isIgnoreNewlineTag(tag) && html[0] === '\\n'\n\nconst startTagMatch = parseStartTag()\nif (startTagMatch) {\n  handleStartTag(startTagMatch)\n  if (shouldIgnoreFirstNewline(startTagMatch.tagName, html)) {\n    advance(1)\n  }\n  continue\n}\n")),(0,r.kt)("p",null,"\u5f00\u59cb\u6807\u7b7e\u5339\u914d\u8fc7\u7a0b\u4e2d\u6d89\u53ca\u5230\u5c5e\u6027\u7b49\u7684\u5904\u7406\uff0c\u62bd\u79bb\u5230\u4e86\u5355\u72ec\u7684\u89e3\u6790\u51fd\u6570 parseStartTag \u91cc\uff0c\u8fd9\u662f\u5176\u7b2c\u4e00\u6b21\u51fa\u73b0\uff0c\u56e0\u6b64\u6211\u4eec\u5728\u8fd9\u91cc\u8fdb\u884c\u8bf4\u660e\uff0c\u5176\u4ee3\u7801\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'function parseStartTag() {\n  const start = html.match(startTagOpen);\n  if (start) {\n    const match = {\n      tagName: start[1],\n      attrs: [],\n      start: index,\n    };\n    advance(start[0].length); // \u8df3\u8fc7\u5f00\u5934\uff0c\u5982<div class="id"></div>\u8df3\u8fc7`div\n    let end, attr;\n    while (\n      !(end = html.match(startTagClose)) &&\n      (attr = html.match(dynamicArgAttribute) || html.match(attribute))\n    ) {\n      attr.start = index;\n      advance(attr[0].length);\n      attr.end = index;\n      match.attrs.push(attr);\n    }\n    if (end) {\n      match.unarySlash = end[1];\n      advance(end[0].length);\n      match.end = index;\n      return match;\n    }\n  }\n}\n')),(0,r.kt)("p",null,"\u5f00\u59cb\u6807\u7b7e\u5339\u914d\u7684\u8fc7\u7a0b\u4e2d\uff0c\u9010\u4e2a\u5411\u540e\u5339\u914d\u63d0\u53d6\u5c5e\u6027\uff0c\u4fdd\u5b58\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"attrs")," \u6570\u7ec4\uff0c\u8fd9\u6837\u8fd4\u56de\u7684 match \u5bf9\u8c61\u65e2\u80fd\u591f\u63cf\u8ff0\u8fd9\u4e2a\u5f00\u59cb\u6807\u7b7e\u81ea\u8eab\u7684\u5185\u5bb9\uff0c\u540c\u65f6\u4e5f\u6807\u8bb0\u4e86\u5176\u6240\u5728\u7684\u4f4d\u7f6e\u3002"),(0,r.kt)("p",null,"\u7ee7\u7eed\u5f80\u4e0b\uff0c\u5982\u679c\u6b63\u5e38\u5339\u914d\u5230\u4e00\u4e2a\u5f00\u59cb\u6807\u7b7e\uff0c\u5c31\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"handleStartTag")," \u8fdb\u884c\u5904\u7406\uff0c\u8fd9\u4e2a\u662f\u4e00\u4e2a\u5f88\u6838\u5fc3\u7684\u8c03\u7528\uff0c\u5176\u6838\u5fc3\u4ee3\u7801\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function handleStartTag(match) {\n  // ...\n  const attrs = new Array(l);\n  for (let i = 0; i < l; i++) {\n    // ...\u8fd9\u91cc\u4e3b\u8981\u5c31\u662f\u5bf9\u5c5e\u6027\u503c\u8fdb\u884c\u4e00\u4e2a\u89e3\u7801\n    attrs[i] = {\n      name: args[1],\n      value: decodeAttr(value, shouldDecodeNewlines),\n    };\n  }\n\n  if (!unary) {\n    stack.push({\n      tag: tagName,\n      lowerCasedTag: tagName.toLowerCase(),\n      attrs: attrs,\n      start: match.start,\n      end: match.end,\n    });\n    lastTag = tagName;\n  }\n\n  if (options.start) {\n    options.start(tagName, attrs, unary, match.start, match.end);\n  }\n}\n")),(0,r.kt)("p",null,"\u9996\u5148\u5c06\u5c5e\u6027\u503c\u8fdb\u884c\u4e86\u89e3\u7801\uff0c\u8fd9\u4e2a\u6211\u4eec\u4e0d\u5fc5\u8fc7\u5206\u5173\u6ce8\u3002\u7136\u540e\u5224\u65ad ",(0,r.kt)("inlineCode",{parentName:"p"},"!unary"),"\uff0c ",(0,r.kt)("inlineCode",{parentName:"p"},"unary")," \u7684\u610f\u601d\u662f\u4e00\u5143\uff0c\u4e5f\u5c31\u662f\u8bf4\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"<br>"),"\u8fd9\u6837\u7684\u81ea\u95ed\u5408\u6807\u7b7e\uff0c\u5f53\u4e0d\u662f\u81ea\u95ed\u5408\u6807\u7b7e\u65f6\uff0c\u5f80 ",(0,r.kt)("inlineCode",{parentName:"p"},"stack")," \u63a8\u5165\u4e86\u4e00\u4e2a\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u662f\u5bf9\u5143\u7d20\u7684\u63cf\u8ff0"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"{\n  tag: tagName, // \u6807\u7b7e\u540d\n  lowerCasedTag: tagName.toLowerCase(),\n  attrs: attrs, // \u5c5e\u6027\u5217\u8868\n  start: match.start, // \u5728\u6a21\u677f\u4e2d\u7684\u5f00\u59cb\u4f4d\u7f6e\n  end: match.end // \u5728\u6a21\u677f\u4e2d\u7684\u7ed3\u675f\u4f4d\u7f6e\n}\n")),(0,r.kt)("p",null,"stack \u5373\u6808\uff0c\u662f\u5b9e\u73b0\u6a21\u677f\u89e3\u6790\u7684\u91cd\u8981\u6570\u636e\u7ed3\u6784\uff0c\u5728\u9047\u5230\u4e00\u4e2a\u975e\u81ea\u95ed\u5408\u6807\u7b7e\u7684\u5f00\u59cb\u6807\u7b7e\u65f6\u5165\u6808\uff0c\u5728\u9047\u5230\u7ed3\u675f\u6807\u7b7e\u65f6\u51fa\u6808\u3002\u7136\u540e lastTag \u6807\u8bb0\u7684\u662f\u6808\u9876\u7684\u6807\u7b7e\u540d\uff0c\u7528\u6765\u5339\u914d\u7ed3\u675f\u6807\u7b7e\u65f6\u8fdb\u884c\u5224\u65ad\u3002"),(0,r.kt)("h3",{id:"end-tag"},"End Tag"),(0,r.kt)("p",null,"\u5339\u914d\u7684\u4ee3\u7801\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const endTagMatch = html.match(endTag)\nif (endTagMatch) {\n  const curIndex = index\n  advance(endTagMatch[0].length)\n  parseEndTag(endTagMatch[1], curIndex, index)\n  continue\n}\n")),(0,r.kt)("p",null,"\u5f53\u5411\u540e\u5339\u914d\u7684\u7ed3\u679c\u4e3a\u7ed3\u675f\u6807\u7b7e\uff0c\u524d\u8fdb\u8df3\u5230\u4e0b\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u7136\u540e\u8c03\u7528 parseEndTag \u5bf9\u5339\u914d\u51fa\u6765\u7684\u7ed3\u679c\u8fdb\u884c\u5904\u7406\uff0c\u8fd9\u91cc\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"parseEndTag")," \u9996\u6b21\u8c03\u7528\uff0c\u5728\u6b64\u8fdb\u884c\u8bf4\u660e\uff0c\u4ee3\u7801\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'function parseEndTag(tagName, start, end) {\n  let pos, lowerCasedTagName;\n  if (start == null) start = index;\n  if (end == null) end = index;\n\n  // Find the closest opened tag of the same type\n  if (tagName) {\n    // @block1\n    lowerCasedTagName = tagName.toLowerCase();\n    for (pos = stack.length - 1; pos >= 0; pos--) {\n      if (stack[pos].lowerCasedTag === lowerCasedTagName) {\n        break;\n      }\n    }\n  } else {\n    // If no tag name is provided, clean shop\n    pos = 0;\n  }\n\n  if (pos >= 0) {\n    // @block2\n    // Close all the open elements, up the stack\n    for (let i = stack.length - 1; i >= pos; i--) {\n      if (\n        process.env.NODE_ENV !== "production" &&\n        (i > pos || !tagName) &&\n        options.warn\n      ) {\n        options.warn(`tag <${stack[i].tag}> has no matching end tag.`, {\n          start: stack[i].start,\n          end: stack[i].end,\n        });\n      }\n      if (options.end) {\n        options.end(stack[i].tag, start, end);\n      }\n    }\n\n    // Remove the open elements from the stack\n    stack.length = pos;\n    lastTag = pos && stack[pos - 1].tag;\n  } else if (lowerCasedTagName === "br") {\n    if (options.start) {\n      options.start(tagName, [], true, start, end);\n    }\n  } else if (lowerCasedTagName === "p") {\n    if (options.start) {\n      options.start(tagName, [], false, start, end);\n    }\n    if (options.end) {\n      options.end(tagName, start, end);\n    }\n  }\n}\n')),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"tagName")," \u5c31\u662f\u6808\u9876\u7684\u6807\u7b7e\u540d\uff0c\u5f53\u5339\u914d\u5230\u7ed3\u675f\u6807\u7b7e\u4e4b\u540e\uff0c\u610f\u5473\u7740\u8fd9\u4e2a tag \u5df2\u7ecf\u5b8c\u6574\u5339\u914d\uff0c\u6839\u636e tagName \u67e5\u627e\u5230\u6700\u8fd1\u4e00\u4e2a\u5339\u914d\u7684\u5f00\u59cb\u6807\u7b7e(@block1)\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u6700\u8fd1\u7684\u4e00\u4e2a\u5339\u914d\u5e94\u8be5\u5c31\u662f\u6808\u9876\uff0c\u4e5f\u5c31\u662f\u8bf4 ",(0,r.kt)("strong",{parentName:"p"},"pos === stack.length - 1")," \u5e94\u8be5\u662f\u6210\u7acb\u7684\uff0c\u4f46\u662f\u5728\u4e66\u5199\u65f6\u53ef\u80fd\u4f1a\u9047\u5230\u6f0f\u5199\u95ed\u5408\u6807\u7b7e\u7684\u60c5\u51b5\uff0c\u5982"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"<div><span>hello</div>\n")),(0,r.kt)("p",null,"\u8fd9\u4e2a\u60c5\u51b5\u4e0b\uff0c\u5f53\u5339\u914d\u5230\u7ed3\u675f\u6807\u7b7e\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"</div>"),"\u65f6\uff0c\u53d1\u73b0\u6808\u9876\u7684\u5143\u7d20\u662f span\uff0c\u8fd9\u4e2a\u65f6\u5019 pos === 0\uff0c\u800c stack.length - 1 === 1\uff0c\u5e76\u4e0d\u5339\u914d(@block2 options.warn)\u3002"),(0,r.kt)("h3",{id:"text"},"Text"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'let text, rest, next;\n// @block1\nif (textEnd >= 0) {\n  rest = html.slice(textEnd);\n  while (\n    !endTag.test(rest) &&\n    !startTagOpen.test(rest) &&\n    !comment.test(rest) &&\n    !conditionalComment.test(rest)\n  ) {\n    // < in plain text, be forgiving and treat it as text\n    next = rest.indexOf("<", 1);\n    if (next < 0) break;\n    textEnd += next;\n    rest = html.slice(textEnd);\n  }\n  text = html.substring(0, textEnd);\n}\n\n// @block2\nif (textEnd < 0) {\n  text = html;\n}\n\n// @block3\nif (text) {\n  advance(text.length);\n}\n\nif (options.chars && text) {\n  options.chars(text, index - text.length, index);\n}\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"@block1"),": textEnd \u662f\u4e0b\u4e00\u4e2a<\u7684\u4f4d\u7f6e\uff0c\u5982\u679c\u5927\u4e8e\u7b49\u4e8e 0\uff0c\u8bf4\u660e\u5f53\u524d\u4f4d\u7f6e\u548c<\u4e4b\u95f4\u7684\u6587\u672c\u662f\u7eaf\u6587\u672c\uff0c\u6216\u8005\u662f<\u5f00\u5934\u7684\u4e00\u6bb5\u7eaf\u6587\u672c\uff0c\u5728\u5411\u540e\u67e5\u627e\u7684\u8fc7\u7a0b\u4e2d\u5224\u65ad<\u5982\u679c\u662f\u7eaf\u6587\u672c\u7684\u4e00\u90e8\u5206\uff0c\u5c31\u7ee7\u7eed\u5411\u540e\u67e5\u627e\uff0c\u4e00\u76f4\u627e\u5230\u8fd9\u6bb5\u6587\u672c\u7ed3\u675f\u7684\u4f4d\u7f6e\uff0c\u5c06\u6587\u672c\u622a\u53d6\u51fa\u6765\u3002"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"@block2"),": textEnd \u5c0f\u4e8e 0 \u8bf4\u660e\u540e\u9762\u6ca1\u6709 <\uff0c\u5373\u6574\u6bb5 html \u90fd\u53ea\u662f\u7eaf\u6587\u672c\uff0c\u4e5f\u5c31\u662f template \u5df2\u7ecf\u89e3\u6790\u5b8c\u6210\u4e86\u3002"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"@block3"),": html \u89e3\u6790\u4f4d\u7f6e\u524d\u8fdb\u5230\u6587\u672c\u7ed3\u675f\u7684\u4f4d\u7f6e\u3002"),(0,r.kt)("h2",{id:"\u751f\u6210-ast"},"\u751f\u6210 AST"),(0,r.kt)("p",null,"\u5728\u672c\u6587\u524d\u9762\u89e3\u6790\u8fc7\u7a0b\u7684\u8bf4\u660e\u4e2d\uff0c\u8bf4\u660e\u4e86 template \u5982\u4f55\u5411\u540e\u89e3\u6790\uff0c\u6839\u636e\u4e0d\u540c\u7684\u7c7b\u522b\u53bb\u505a\u76f8\u5e94\u7684\u5904\u7406\uff0c\u4e5f\u89e3\u91ca\u4e86 advance\u3001parseStartTag\u3001handleStartTag \u548c parseEndTag \u8fd9\u4e9b\u5904\u7406\u51fd\u6570\uff0c\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u5173\u952e\u7684\u5185\u5bb9\u6ca1\u6709\u8bf4"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u4e0a\u9762\u7684\u8fd9\u51e0\u4e2a\u5904\u7406\u51fd\u6570\uff0c\u90fd\u662f\u63a7\u5236 template \u5b57\u7b26\u4e32\u7684\u89e3\u6790\u548c\u524d\u8fdb\uff0c\u4f46\u662f\u5bf9\u89e3\u6790\u51fa\u6765\u7684\u5185\u5bb9\uff0c\u505a\u4e86\u4ec0\u4e48\u5904\u7406\u5462\uff0c\u5728\u54ea\u91cc\u751f\u6210\u4e86 AST\uff1f")),(0,r.kt)("p",null,"\u8fd9\u4e9b\u5c31\u662f parseHTML \u8c03\u7528\u65f6\u4f20\u9012\u7684\u51e0\u4e2a\u51fd\u6570\u53c2\u6570\u505a\u7684\u4e8b\u60c5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"parseHTML(template, {\n  // ...partOfPropertiesOfoptions\n\n  start(tag, attrs, unary, start, end) {\n    // ...\n  },\n  end(tag, start, end) {\n    // ...\n  },\n  chars(text: string, start: number, end: number) {\n    // ...\n  },\n  comment(text: string, start, end) {\n    // ...\n  },\n});\n")),(0,r.kt)("p",null,"\u8fd9\u51e0\u4e2a\u51fd\u6570\u5728\u524d\u9762\u8bf4\u660e\u89e3\u6790\u8fc7\u7a0b\u4e2d\u6709\u76f8\u5e94\u7684\u8c03\u7528\uff0c\u4f46\u4e3a\u4e86\u4e0d\u6253\u65ad\u6211\u4eec\u7406\u89e3 ",(0,r.kt)("strong",{parentName:"p"},"template \u5b57\u7b26\u4e32\u4ece\u5934\u5230\u5c3e\u5339\u914d\u7684\u8fc7\u7a0b"),"\uff0c\u524d\u9762\u53ea\u5173\u6ce8",(0,r.kt)("strong",{parentName:"p"},"\u5339\u914d"),"\uff0c\u800c\u5bf9",(0,r.kt)("strong",{parentName:"p"},"\u5339\u914d\u7ed3\u679c\u7684\u5904\u7406"),"\u6682\u65f6\u7565\u8fc7\u4e86\uff0c\u4e0b\u9762\u5c31\u7814\u7a76\u4e00\u4e0b ",(0,r.kt)("strong",{parentName:"p"},"optons.xxx")," \u8fd9\u4e9b\u65b9\u6cd5\uff0c\u8bf4\u660e\u5339\u914d\u7684\u7ed3\u679c\u662f\u5982\u4f55\u5904\u7406\u7684\u3002"),(0,r.kt)("h3",{id:"optionscomment"},"options.comment"),(0,r.kt)("p",null,"\u6839\u636e\u524d\u9762\u7684\u4f8b\u5b50\uff0c\u5f53\u5339\u914d\u5230\u4e3a\u4e00\u4e2a\u6ce8\u91ca\u7684\u65f6\u5019\uff0c\u5b83\u7684\u8c03\u7528\u662f\u7c7b\u4f3c\u8fd9\u6837\u7684"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'// options.comment(\u6ce8\u91ca\u5185\u5bb9, \u6ce8\u91ca\u5185\u5bb9\u5728\u6a21\u677f\u4e2d\u7684\u5f00\u59cb\u4f4d\u7f6e, \u6ce8\u91ca\u5185\u5bb9\u5728\u6a21\u677f\u4e2d\u7684\u5f00\u59cb\u4f4d\u7f6e)\noptions.comment(" this is a comment ", 20, 24);\n')),(0,r.kt)("p",null,"\u770b\u4e00\u4e0b\u5b83\u7684\u5b9e\u73b0"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"comment (text: string, start, end) {\n  // adding anyting as a sibling to the root node is forbidden\n  // comments should still be allowed, but ignored\n  if (currentParent) {\n    const child: ASTText = {\n      type: 3,\n      text,\n      isComment: true\n    }\n    if (process.env.NODE_ENV !== 'production' && options.outputSourceRange) {\n      child.start = start\n      child.end = end\n    }\n    currentParent.children.push(child)\n  }\n}\n")),(0,r.kt)("p",null,"\u5f53\u7236\u8282\u70b9\u5b58\u5728\u65f6\uff0c\u5c06\u6ce8\u91ca\u6587\u672c\u4f5c\u4e3a\u4e00\u4e2a\u6807\u8bb0\u4e86 ",(0,r.kt)("inlineCode",{parentName:"p"},"isComment")," \u7684 AST \u7ed3\u70b9\u4fdd\u5b58\u5230\u7236\u8282\u70b9\u7684 children \u5c5e\u6027\u4e2d\uff0c\u800c start \u548c end \u5e94\u8be5\u53ea\u662f\u5728 dev \u73af\u5883\u4e0b\u505a\u63d0\u793a\u7528\u3002"),(0,r.kt)("p",null,"\u5f53\u4e0d\u5b58\u7236\u8282\u70b9\u7684\u65f6\u5019\uff0c\u4e5f\u5c31\u662f\u548c\u6839\u7ed3\u70b9\u540c\u7ea7\u7684\u6ce8\u91ca\u4f1a\u76f4\u63a5\u88ab\u4e22\u5f03\uff0c\u5982\u4e0b\u9762\u4f8b\u5b50\u6240\u793a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'new Vue({\n  template: `<div class="header">\x3c!-- this is a comment --\x3e</div>\x3c!-- \u8fd9\u91cc\u7684\u6ce8\u91ca\u4f1a\u76f4\u63a5\u6254\u6389 --\x3e`,\n});\n')),(0,r.kt)("h3",{id:"optionsstart"},"options.start"),(0,r.kt)("p",null,"\u8fd9\u4e2a\u51fd\u6570\u5728\u5339\u914d\u5230\u4e00\u4e2a\u5f00\u59cb\u6807\u7b7e\u7684\u65f6\u5019\u8c03\u7528\uff0c\u6839\u636e\u6211\u4eec\u7684\u4f8b\u5b50\uff0c\u8fd9\u91cc\u7b2c\u4e00\u6b21\u8c03\u7528\uff0c\u662f\u5339\u914d\u5230",(0,r.kt)("inlineCode",{parentName:"p"},'<div class="header">'),"\uff0c\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'options.start(\n  "div",\n  [\n    {\n      name: "class",\n      value: "header",\n      end: 19,\n      start: 5,\n    },\n  ],\n  false,\n  0,\n  20\n);\n')),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"start"),"\u51fd\u6570\u4f2a\u4ee3\u7801\u8868\u793a\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function start (tag, attrs, unary, start, end) {\n  let element = createASTElement(tag, attrs, currentParent) // ...\n\n  processElement(element); // ...\n\n  setElementRelationship(elemnt); // ...\n},\n")),(0,r.kt)("p",null,"\u62bd\u6210\u4e86\u4e09\u4e2a\u90e8\u5206\uff0c\u5206\u522b\u662f"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u521b\u5efa AST \u5143\u7d20"),(0,r.kt)("li",{parentName:"ul"},"\u5904\u7406\u751f\u6210\u7684 AST \u5143\u7d20"),(0,r.kt)("li",{parentName:"ul"},"\u8bbe\u7f6e\u5143\u7d20\u5173\u7cfb\uff0c\u5373\u8282\u70b9\u76f8\u4e92\u4e4b\u95f4\u7684\u5173\u8054\uff0c\u7236\u5b50\u5173\u7cfb")),(0,r.kt)("h4",{id:"\u521b\u5efa-ast-\u5143\u7d20"},"\u521b\u5efa AST \u5143\u7d20"),(0,r.kt)("p",null,"\u4ee3\u7801\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'// check namespace.\n// inherit parent ns if there is one\nconst ns = (currentParent && currentParent.ns) || platformGetTagNamespace(tag);\n\n// handle IE svg bug\n/* istanbul ignore if */\nif (isIE && ns === "svg") {\n  attrs = guardIESVGBug(attrs);\n}\n\nlet element: ASTElement = createASTElement(tag, attrs, currentParent);\nif (ns) {\n  element.ns = ns;\n}\n')),(0,r.kt)("p",null,"\u901a\u8fc7 createASTElement \u521b\u5efa\u4e86\u4e00\u4e2a AST \u5143\u7d20\uff0c\u7136\u540e\u8bbe\u7f6e\u4e86 namespace \u7ee7\u627f\u81ea\u7236\u8282\u70b9\u3002"),(0,r.kt)("h4",{id:"\u5904\u7406-ast-\u5143\u7d20"},"\u5904\u7406 AST \u5143\u7d20"),(0,r.kt)("p",null,"\u521b\u5efa\u7684 element \u662f\u4e2a\u57fa\u7840\u7684\u6837\u677f\uff0c\u9700\u8981\u505a\u4e00\u4e9b\u68c0\u67e5\uff0c\u9488\u5bf9\u4e00\u4e9b\u7279\u6b8a\u60c5\u51b5\u505a\u5904\u7406"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'if (process.env.NODE_ENV !== "production") {\n  // \u8fd9\u91cc\u5c31\u662f\u68c0\u67e5\uff0c\u63d0\u793a\u4f60\u522b\u7ed9\u5c5e\u6027\u641e\u4e00\u4e9b\u4e71\u4e03\u516b\u7cdf\u7684\u5b57\u7b26\n}\n\nif (isForbiddenTag(element) && !isServerRendering()) {\n  element.forbidden = true;\n  // \u68c0\u67e5\u63d0\u793a\u4f60\uff0c\u522b\u5728 template \u4e0a\u641e style,script \u8fd9\u4e9b\u5185\u5bb9\uff0c\u8981\u6309\u5957\u8def\u6765\n}\n\n// apply pre-transforms\nfor (let i = 0; i < preTransforms.length; i++) {\n  element = preTransforms[i](element, options) || element;\n}\n\nif (!inVPre) {\n  processPre(element);\n  if (element.pre) {\n    inVPre = true;\n  }\n}\nif (platformIsPreTag(element.tag)) {\n  inPre = true;\n}\nif (inVPre) {\n  processRawAttrs(element);\n} else if (!element.processed) {\n  // structural directives\n  processFor(element);\n  processIf(element);\n  processOnce(element);\n}\n')),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"preTransforms")," \u662f\u5bf9 ",(0,r.kt)("inlineCode",{parentName:"p"},"input")," \u8fd9\u4e2a\u5143\u7d20\u505a\u4e00\u4e9b\u6bd4\u8f83\u7279\u6b8a\u7684\u5904\u7406\uff0c\u4e0d\u7528\u5728\u6b64\u53bb\u7ec6\u7ea0\u3002\u518d\u5f80\u4e0b\uff0cprocessXXX \u90fd\u662f\u9488\u5bf9\u4e0d\u540c\u7684\u5185\u7f6e\u6307\u4ee4\u53bb\u505a\u5904\u7406\uff0c\u5728 element \u4e0a\u9762\u6dfb\u52a0\u4e00\u4e9b\u62d3\u5c55\u5c5e\u6027\uff0c\u6bd4\u5982 processPre \u662f\u5224\u65ad\u662f\u5426\u6709 v-pre \u6307\u4ee4\u6dfb\u52a0 element.pre \u6807\u8bb0\uff0cprocessOnce \u662f\u6dfb\u52a0 element.once \u6807\u8bb0\u3002\u5bf9\u4e8e ",(0,r.kt)("inlineCode",{parentName:"p"},"processFor")," \u548c ",(0,r.kt)("inlineCode",{parentName:"p"},"processIf")," \u5219\u6bd4\u8f83\u590d\u6742\uff0c\u56e0\u4e3a\u4ed6\u4eec\u4e0d\u662f\u4e00\u4e2a boolean \u7c7b\u578b\u6307\u4ee4\uff0c\u4e0d\u4ec5\u8981\u77e5\u9053\u6709\u8fd8\u662f\u6ca1\u6709\uff0c\u8fd8\u6709\u77e5\u9053\u5177\u4f53\u662f\u4ec0\u4e48\uff0c\u8981\u786e\u5b9a\u4f9d\u8d56\u548c\u5bf9\u5e94\u5173\u7cfb\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"processFor")),(0,r.kt)("p",null,"\u5047\u8bbe\u6211\u4eec\u6709\u8fd9\u6837\u4e00\u4e2a\u4f8b\u5b50"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'new Vue({\n  data() {\n    return {\n      myObject: {\n        title: "How to do lists in Vue",\n        author: "Jane Doe",\n        publishedAt: "2020-03-22",\n      },\n    };\n  },\n  template: `<li v-for="(value, name, index) in myObject">\n  {{ index }}. {{ name }}: {{ value }}\n</li>`,\n}).$mount("#app");\n')),(0,r.kt)("p",null,"\u518d\u6765\u770b v-for \u6307\u4ee4\u7684 process \u5b9e\u73b0"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'export function processFor(el: ASTElement) {\n  let exp;\n  if ((exp = getAndRemoveAttr(el, "v-for"))) {\n    const res = parseFor(exp);\n    if (res) {\n      extend(el, res);\n    } else if (process.env.NODE_ENV !== "production") {\n      warn(`Invalid v-for expression: ${exp}`, el.rawAttrsMap["v-for"]);\n    }\n  }\n}\n\ntype ForParseResult = {\n  for: string,\n  alias: string,\n  iterator1?: string,\n  iterator2?: string,\n};\n\nexport function parseFor(exp: string): ?ForParseResult {\n  const inMatch = exp.match(forAliasRE);\n  if (!inMatch) return;\n  const res = {};\n  res.for = inMatch[2].trim();\n  const alias = inMatch[1].trim().replace(stripParensRE, "");\n  const iteratorMatch = alias.match(forIteratorRE);\n  if (iteratorMatch) {\n    res.alias = alias.replace(forIteratorRE, "").trim();\n    res.iterator1 = iteratorMatch[1].trim();\n    if (iteratorMatch[2]) {\n      res.iterator2 = iteratorMatch[2].trim();\n    }\n  } else {\n    res.alias = alias;\n  }\n  return res;\n}\n')),(0,r.kt)("p",null,"\u5728 v-for \u8fd9\u4e2a\u6307\u4ee4\u7684\u4f7f\u7528\u4e2d\uff0c\u6700\u591a\u53ef\u80fd\u4f1a\u5b9a\u4e49\u56db\u4e2a\u53d8\u91cf\uff0c\u8fd9\u91cc\u4f1a\u7ed9\u8fd9\u56db\u4e2a\u53d8\u91cf\u53d6\u4e00\u4e2a\u786e\u5b9a\u7684\u522b\u540d\uff0c\u5982 ForParseResult \u91cc\u9762\u6240\u793a\uff0c\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u7ed3\u679c\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n  ...element\n  alias: "value",\n  for: "myObject",\n  iterator1: "name",\n  iterator2: "index",\n}\n')),(0,r.kt)("p",null,"\u56e0\u4e3a\u7528\u6237\u914d\u7f6e\u65f6\u7ed9\u8fd9\u51e0\u4e2a\u89d2\u8272\u53d6\u7684\u540d\u79f0\u662f\u53ef\u53d8\u7684\uff0c\u800c\u8fd9\u51e0\u4e2a\u89d2\u8272\u662f\u56fa\u5b9a\u7684\uff0c\u901a\u8fc7\u5185\u90e8\u7684\u540d\u5b57\u8f6c\u6362\u65b9\u4fbf\u4e86\u540e\u7eed\u7684\u5904\u7406\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"processIf")),(0,r.kt)("p",null,"\u4ee3\u7801\u5c31\u4e0d\u8d34\u4e86\uff0c\u76f4\u63a5\u770b\u4e2a\u7ed3\u679c"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<div v-if="showDemo">demo</div>\n')),(0,r.kt)("p",null,"\u5904\u7406\u540e element \u53d8\u6210"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n  ...element\n  if: "showDemo",\n  ifConditions: [\n    {\n      block: element, // \u6307\u5411element\u81ea\u8eab,\n      exp: "showDemo"\n    }\n  ]\n}\n')),(0,r.kt)("p",null,"v-else\uff0cv-else-if \u4e5f\u662f\u7c7b\u4f3c\u7684\u3002"),(0,r.kt)("h4",{id:"\u8bbe\u7f6e\u5143\u7d20\u5173\u7cfb"},"\u8bbe\u7f6e\u5143\u7d20\u5173\u7cfb"),(0,r.kt)("p",null,"\u4ee3\u7801\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'if (!root) {\n  root = element;\n  if (process.env.NODE_ENV !== "production") {\n    checkRootConstraints(root);\n  }\n}\n\nif (!unary) {\n  currentParent = element;\n  stack.push(element);\n} else {\n  closeElement(element);\n}\n')),(0,r.kt)("p",null,"\u9996\u5148\u5224\u65ad root \u8282\u70b9\u662f\u5426\u5b58\u5728\uff0c\u4e0d\u5b58\u5728\u5c31\u8bbe\u7f6e root \u8282\u70b9\uff0c\u5982\u679c\u5b58\u5728\u4e14\u975e\u81ea\u95ed\u5408\u6807\u7b7e\u90a3\u4e48\u5c06\u5143\u7d20\u63a8\u5230 stack \u91cc\u9762\u3002\u5bf9\u4e8e\u81ea\u95ed\u5408\u6807\u7b7e\uff0c\u8c03\u7528\u4e86 closeElement\uff0c\u8fd9\u4e2a\u51fd\u6570\u5185\u5bb9\u6bd4\u8f83\u590d\u6742\uff0c\u6211\u4eec\u7a0d\u540e\u5355\u72ec\u89e3\u91ca\uff0c\u603b\u4e4b\u5c31\u662f\u5728\u4e00\u4e2a\u5143\u7d20\u5b8c\u6574\u627e\u5230\u540e\uff0c\u786e\u5b9a\u8c01\u662f\u7239\u8c01\u662f\u513f\u7838\u987a\u4fbf\u8fd8\u505a\u4e00\u4e9b\u5408\u6cd5\u6027\u68c0\u67e5\u3002"),(0,r.kt)("h4",{id:"end"},"end"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function end (tag, start, end) {\n  const element = stack[stack.length - 1]\n  // pop stack\n  stack.length -= 1\n  currentParent = stack[stack.length - 1]\n  if (process.env.NODE_ENV !== 'production' && options.outputSourceRange) {\n    element.end = end\n  }\n  closeElement(element)\n},\n")),(0,r.kt)("p",null,"end \u662f\u5728\u89e3\u6790\u5230\u95ed\u5408\u6807\u7b7e\u65f6\u88ab\u8c03\u7528\uff0c\u9996\u5148\u5c06\u6808\u9876\u5143\u7d20\u5f39\u51fa\uff0c\u7136\u540e\u8ba9\u4e0b\u4e00\u4e2a\u5143\u7d20\u4f5c\u4e3a currentParent\u3002currentParent \u662f\u5728\u521b\u5efa AST \u5143\u7d20\u7684\u65f6\u5019\u4f20\u5165\u4f5c\u4e3a parent \u5c5e\u6027\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u5f53\u4e0b\u4e00\u4e2a\u5143\u7d20\u5165\u6808\u65f6\uff0c\u8bbe\u7f6e\u7684 parent \u5c31\u662f\u5f53\u524d\u6808\u9876\u5143\u7d20\uff0c\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u7236\u5b50\u5173\u7cfb\u7684\u8054\u7cfb\u3002"),(0,r.kt)("h4",{id:"chars"},"chars"),(0,r.kt)("p",null,"\u8fd9\u4e2a\u51fd\u6570\u662f\u7528\u6765\u5904\u7406\u6587\u672c\u7684\uff0c\u7b80\u5316\u4ee3\u7801\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function chars (text: string, start: number, end: number) {\n  const children = currentParent.children\n  if (text) {\n    let child: ?ASTNode\n    if (!inVPre && text !== ' ' && (res = parseText(text, delimiters))) {\n      child = {\n        type: 2,\n        expression: res.expression,\n        tokens: res.tokens,\n        text\n      }\n    } else if (text !== ' ' || !children.length || children[children.length - 1].text !== ' ') {\n      child = {\n        type: 3,\n        text\n      }\n    }\n    if (child) {\n      children.push(child)\n    }\n  }\n},\n")),(0,r.kt)("p",null,"\u770b\u4e2a\u4f8b\u5b50"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'new Vue({\n  data() {\n    return {\n      name: "myy",\n      age: 26,\n    };\n  },\n  template: `<li>name is: {{name}}, age is: {{age}} </li>`,\n}).$mount("#app");\n')),(0,r.kt)("p",null,"\u5f53\u8fdb\u5165 ",(0,r.kt)("inlineCode",{parentName:"p"},"if (text)")," \u5757\u65f6\uff0cchild \u7ed3\u679c\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'child: {\n  expression: ""name is: "+_s(name)+", age is: "+_s(age)+" ""\n  text: "name is: {{name}}, age is: {{age}} "\n  type: 2,\n  tokens: [\n    "name is: ",\n    {\n      @binding: "name",\n    },\n    ", age is: ",\n    {\n      @binding: "age"\n    }\n  ]\n}\n')),(0,r.kt)("p",null,"\u800c\u5982\u679c template \u662f\u7eaf\u6587\u672c\u5982 this is msg\uff0c\u5219\u7ed3\u679c\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"{\n  type: 3,\n  text: 'this is msg'\n}\n")),(0,r.kt)("p",null,"\u603b\u7ed3\u8d77\u6765\u5c31\u662f\u4f1a\u6839\u636e\u6587\u672c\u7684\u7c7b\u578b\u505a\u4e0d\u540c\u7684\u5904\u7406\uff0c\u7528\u4e0d\u540c\u7684 type \u503c\u533a\u5206\uff0c\u6a21\u677f\u7c7b\u578b\u7684\u6587\u672c\u4f1a\u62c6\u5206\u6210\u4e00\u4e2a tokens \u6570\u7ec4\u5e76\u6807\u8bb0\u4f9d\u8d56\u7684\u53d8\u91cf\u3002"),(0,r.kt)("p",null,"\u4e0d\u7ba1\u54ea\u79cd\u7c7b\u578b\uff0c\u6587\u672c\u90fd\u662f\u4ee5\u4e00\u4e2a child \u7ed3\u70b9\u7684\u89d2\u8272\u5b58\u5728\uff0c\u5b83\u90fd\u662f\u513f\u7838\u5f53\u4e0d\u4e86\u7239\uff0c\u9636\u7ea7\u5df2\u7ecf\u56fa\u5316\u3002"),(0,r.kt)("h4",{id:"closeelement"},"closeElement"),(0,r.kt)("p",null,"\u8fd9\u4e2a\u51fd\u6570\u662f\u5728\u627e\u5230\u4e00\u4e2a\u81ea\u95ed\u5408\u6807\u7b7e\uff0c\u6216\u8005\u627e\u5230\u4e00\u4e2a\u7ed3\u675f\u6807\u7b7e\u65f6\u8c03\u7528\u7684"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'function closeElement(element) {\n  trimEndingWhitespace(element);\n  if (!inVPre && !element.processed) {\n    element = processElement(element, options);\n  }\n  // tree management\n  if (!stack.length && element !== root) {\n    // allow root elements with v-if, v-else-if and v-else\n    if (root.if && (element.elseif || element.else)) {\n      if (process.env.NODE_ENV !== "production") {\n        checkRootConstraints(element);\n      }\n      addIfCondition(root, {\n        exp: element.elseif,\n        block: element,\n      });\n    } else if (process.env.NODE_ENV !== "production") {\n      warnOnce(\n        `Component template should contain exactly one root element. ` +\n          `If you are using v-if on multiple elements, ` +\n          `use v-else-if to chain them instead.`,\n        { start: element.start }\n      );\n    }\n  }\n  if (currentParent && !element.forbidden) {\n    if (element.elseif || element.else) {\n      processIfConditions(element, currentParent);\n    } else {\n      if (element.slotScope) {\n        // scoped slot\n        // keep it in the children list so that v-else(-if) conditions can\n        // find it as the prev node.\n        const name = element.slotTarget || \'"default"\';\n        (currentParent.scopedSlots || (currentParent.scopedSlots = {}))[name] =\n          element;\n      }\n      currentParent.children.push(element);\n      element.parent = currentParent;\n    }\n  }\n\n  // final children cleanup\n  // filter out scoped slots\n  element.children = element.children.filter((c) => !(c: any).slotScope);\n  // remove trailing whitespace node again\n  trimEndingWhitespace(element);\n\n  // check pre state\n  if (element.pre) {\n    inVPre = false;\n  }\n  if (platformIsPreTag(element.tag)) {\n    inPre = false;\n  }\n  // apply post-transforms\n  for (let i = 0; i < postTransforms.length; i++) {\n    postTransforms[i](element, options);\n  }\n}\n')),(0,r.kt)("p",null,"\u5bf9 element \u548c currentParent \u8fdb\u884c\u4e86\u5173\u8054\uff0c\u8fd8\u5305\u542b\u4e86\u4e00\u4e9b\u6761\u4ef6\u5224\u65ad\u76f8\u5173\u7684\u68c0\u67e5\uff0c\u6bd4\u5982\u8bf4\u6839\u5143\u7d20\u4e0d\u80fd\u6709\u591a\u4e2a\uff0c\u6ca1\u6709 v-if \u5374\u6709 v-else \u4e00\u7c7b\u7684\u3002"),(0,r.kt)("h2",{id:"\u7279\u522b\u8bf4\u660e"},"\u7279\u522b\u8bf4\u660e"),(0,r.kt)("p",null,"\u8bf4\u660e\u4e00\u4e9b\u7279\u522b\u7684\u5730\u65b9"),(0,r.kt)("h3",{id:"ifconditions-\u7684\u7279\u522b\u4e4b\u5904"},"ifConditions \u7684\u7279\u522b\u4e4b\u5904"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"addIfCondition")," \u8d1f\u8d23\u5411\u5143\u7d20\u6dfb\u52a0\u5bf9\u4e8e ",(0,r.kt)("inlineCode",{parentName:"p"},"v-if"),"\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"v-else-if")," \u548c ",(0,r.kt)("inlineCode",{parentName:"p"},"v-else")," \u5c5e\u6027\u7684\u63cf\u8ff0\uff0c\u8fd9\u4e9b\u6761\u4ef6\u5224\u65ad\u5173\u7cfb\u7edf\u4e00\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"v-if")," \u6240\u5728\u5143\u7d20\u3002\u4e3e\u4f8b\u6765\u8bf4"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'new Vue({\n  data() {\n    return {\n      show: 1,\n    };\n  },\n  template: `<li><span v-if="show === 1">span</span><p v-else-if="show === 2">in p</p></li>`,\n}).$mount("#app");\n')),(0,r.kt)("p",null,"\u5728 span \u8282\u70b9\u4e2d\uff0c\u4f1a\u6709\u5982\u4e0b\u5c5e\u6027"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{\n  if: "show === 1"\n  ifConditions: [\n    {\n      block: // span\u81ea\u8eab\u7684\u5f15\u7528\n      exp: "show === 1"\n    },\n    {\n      block: // p\u6807\u7b7e\u7684\u5f15\u7528\n      exp: "show === 2"\n    }\n  ]\n}\n')),(0,r.kt)("p",null,"\u800c\u5bf9\u4e8e p \u8282\u70b9\uff0c\u5e76\u4e0d\u4f1a\u6709 ifConditions \u6216\u8005 elseifConditions \u8fd9\u6837\u7684\u63cf\u8ff0\u3002\u8fd9\u4e2a\u7279\u70b9\u5728\u540e\u9762 AST \u4f18\u5316\u7684\u8fc7\u7a0b\u4e2d\u4f1a\u7528\u5230"),(0,r.kt)("h2",{id:"\u603b\u7ed3"},"\u603b\u7ed3"),(0,r.kt)("p",null,"\u4e3b\u8981\u5206\u6210\u4e24\u4e2a\u90e8\u5206\uff0c\u6a21\u677f\u7684\u89e3\u6790 \u548c AST \u7684\u751f\u6210\uff0c\u5206\u522b\u5bf9\u5e94\u4e24\u4e2a\u51fd\u6570"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"parseHTML\uff1a\u6a21\u677f\u7684\u89e3\u6790"),(0,r.kt)("li",{parentName:"ul"},"parse\uff1aAST \u7684\u751f\u6210")),(0,r.kt)("p",null,"parse \u8c03\u7528 parseHTML\uff0cparseHTML \u6709\u81ea\u5df1\u7684\u4e00\u4e2a stack\uff0c\u4e13\u95e8\u7528\u6765\u63a7\u5236 template \u5b57\u7b26\u4e32\u89e3\u6790\uff0c\u5176\u4e2d\u7684\u5143\u7d20\u683c\u5f0f\u5982\u4e0b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"{\n  tag: tagName,\n  lowerCasedTag: tagName.toLowerCase(),\n  attrs: attrs,\n  start: match.start,\n  end: match.end\n}\n")),(0,r.kt)("p",null,"\u5916\u5c42\u7684 parse \u4e5f\u6709\u4e00\u4e2a stack\uff0c\u5176\u5143\u7d20\u662f\u4e00\u4e2a\u66f4\u52a0\u4e30\u5bcc\u7684\u63cf\u8ff0\u5bf9\u8c61\uff0c\u589e\u52a0\u4e86\u7c7b\u522b\u548c\u7236\u5b50\u5173\u7cfb\u6307\u5411"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"{\n  type: 1,\n  tag,\n  attrsList: attrs,\n  attrsMap: makeAttrsMap(attrs),\n  rawAttrsMap: {},\n  parent,\n  children: []\n}\n")),(0,r.kt)("p",null,"parseHTML \u7684\u6bcf\u4e00\u6b21\u5339\u914d\uff0c\u90fd\u4f1a\u8c03\u7528 parse \u4f20\u5165\u7684\u51fd\u6570\u8fdb\u884c\u76f8\u5e94\u7684\u5904\u7406\uff0c\u53bb\u505a\u5143\u7d20\u7684\u68c0\u67e5\uff0c\u8f6c\u6362\uff0c\u7236\u5b50\u5173\u7cfb\u7684\u5173\u8054\uff0c\u6267\u884c\u76f8\u5e94\u7684\u51fa\u6808\u5165\u6808\u64cd\u4f5c\u3002"),(0,r.kt)("p",null,"\u5f53\u6808\u6e05\u7a7a\u65f6\uff0c\u7531\u4e8e\u6839\u7ed3\u70b9\u5f15\u7528\u4fdd\u5b58\u5728 root \u4e2d\uff0croot \u5c31\u662f\u6211\u4eec\u7684\u62bd\u8c61\u8bed\u6cd5\u6811\uff0c\u4e5f\u662f parse \u51fd\u6570\u7684\u8fd4\u56de\u503c"))}u.isMDXComponent=!0}}]);